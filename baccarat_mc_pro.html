<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç™¾å®¶æ¨‚å‹ç‡ PROï¼ˆ8å‰¯ç‰Œï½œæ‰£ç‰Œï½œç‡’ç‰Œï½œè’™åœ°å¡ç¾…ï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif; margin:18px; line-height:1.4;}
    h1{margin:0 0 8px;}
    .muted{color:#666;}
    .warn{color:#b00020;}
    .ok{color:#0b6;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .card{border:1px solid #ddd; border-radius:12px; padding:14px; margin-top:12px; background:#fff;}
    textarea,input,button,select{font:inherit;}
    textarea{width:640px; max-width:100%; height:92px; padding:10px; border-radius:10px; border:1px solid #ccc;}
    input[type="number"]{padding:8px 10px; border-radius:10px; border:1px solid #ccc; width:140px;}
    input[type="checkbox"]{transform:scale(1.2); margin-right:6px;}
    button{padding:10px 12px; border-radius:10px; border:1px solid #ccc; background:#fff; cursor:pointer;}
    button:hover{background:#f6f6f6;}
    button.primary{border-color:#111; background:#111; color:#fff;}
    button.primary:hover{background:#000;}
    button.danger{border-color:#b00020; color:#b00020;}
    button.ghost{border-color:#ddd; background:#fafafa;}
    .pill{display:inline-block; padding:2px 10px; border-radius:999px; border:1px solid #ddd; background:#fafafa;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(210px,1fr)); gap:10px;}
    .big{font-size:1.15rem;}
    .kbd{padding:1px 6px; border:1px solid #ddd; border-bottom-width:2px; border-radius:6px; background:#fafafa; font-family:ui-monospace,monospace;}
    .list{max-height:220px; overflow:auto; border:1px solid #eee; border-radius:10px; padding:10px; background:#fcfcfc;}
    .hr{height:1px; background:#eee; margin:10px 0;}
    .progress{height:10px; background:#eee; border-radius:999px; overflow:hidden;}
    .bar{height:100%; width:0%; background:#111;}
    .small{font-size:0.92rem;}
    .tag{display:inline-block; padding:3px 10px; border-radius:999px; border:1px solid #eee; background:#fff; font-size:0.92rem;}
    .kpad{display:grid; grid-template-columns: repeat(7, minmax(44px, 1fr)); gap:8px; margin-top:10px;}
    .kbtn{padding:12px 0; text-align:center; border-radius:12px; border:1px solid #ddd; background:#fff; font-weight:700;}
    .kbtn:active{transform:translateY(1px);}
    .kbtn10{grid-column: span 2;}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:12px; border:1px solid #ddd; background:#fff;}
    .chip b{font-weight:800;}
    .twoCol{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 680px){ .twoCol{grid-template-columns: 1fr;} .kpad{grid-template-columns: repeat(5, minmax(44px, 1fr));} }
    /* ğŸ” é ‚éƒ¨å›ºå®šçµæœå€ï¼ˆæ‰‹æ©Ÿè¶…å¥½ç”¨ï¼‰ */
    .sticky-result{
      position: sticky;
      top: 0;
      z-index: 100;
      background: #ffffff;
      box-shadow: 0 6px 12px rgba(0,0,0,0.06);
    }
    @media (max-width: 600px){
      .sticky-result{
        border-radius: 0;
        margin: 0 -18px 12px -18px;
      }
    }
  </style>
</head>
<body>

  <!-- ğŸ”¥ å³æ™‚çµæœå€ï¼ˆå›ºå®šåœ¨æœ€ä¸Šé¢ï¼‰ -->
  <div class="card sticky-result">
    <div class="big"><b>ğŸ“Š ä¸‹ä¸€å±€ä¼°è¨ˆå‹ç‡ï¼ˆå·²æ‰£ç‰Œï¼‰</b></div>

    <div class="grid" style="margin-top:8px;">
      <div>
        <div class="muted">é–’ (Player)</div>
        <div id="pProb" class="big mono">â€”</div>
      </div>
      <div>
        <div class="muted">èŠ (Banker)</div>
        <div id="bProb" class="big mono">â€”</div>
      </div>
      <div>
        <div class="muted">å’Œ (Tie)</div>
        <div id="tProb" class="big mono">â€”</div>
      </div>
      <div>
        <div class="muted">å»ºè­°ï¼ˆEVæœ€é«˜ï¼‰</div>
        <div id="rec" class="big mono">â€”</div>
        <div id="rec2" class="muted small"></div>
      </div>
    </div>
  </div>

  <h1>ç™¾å®¶æ¨‚å‹ç‡ PROï¼ˆ8å‰¯ç‰Œï½œæ‰£é™¤å·²é–‹ç‰Œï½œç‡’ç‰Œï½œè’™åœ°å¡ç¾…ï¼‰</h1>

  <div class="muted small">
    âœ… ä½ ç¾åœ¨æ˜¯ã€ŒæŒ‰éˆ•è¼¸å…¥ç‰Œã€ï¼šé»ç‰Œé¢å°±åŠ å…¥ï¼ˆä¸ç”¨åˆ†èŠ/é–’ï¼Œåªè¦æŠŠçœ‹è¦‹çš„ç‰Œå…¨éƒ¨æ‰£æ‰å³å¯ï¼‰
    <br/>
    å¿«æ·éµï¼š<span class="kbd">M</span>=è¨ˆç®—ä¸‹ä¸€å±€ï½œ<span class="kbd">Esc</span>=æ¸…æš«å­˜ï½œ<span class="kbd">R</span>=é‡ç½®
    <br/>
    <span class="pill mono">ç¶²å€å¸¶å…¥</span>ï¼š<span class="pill mono">?cards=8,8,2,3&auto=1</span>ï¼ˆè‡ªå‹•åŠ å…¥ä¸¦è¨ˆç®—ï¼‰
  </div>

  <div class="card">
    <div class="twoCol" style="align-items:start;">
      <!-- å·¦ -->
      <div>
        <div class="big"><b>æ­¥é©Ÿ 0ï¼šç‡’ç‰Œï¼ˆå¯é¸ï¼‰</b></div>
        <div class="muted small">å¸¸è¦‹è¦å‰‡ï¼šæŠ½ä¸€å¼µã€Œç‡’ç‰Œç‰Œé¢ã€ï¼Œä¾é»æ•¸å†ç‡’ N å¼µï¼ˆA=1ï¼Œ2-9=åŒé»æ•¸ï¼Œ10/J/Q/K=10ï¼‰ã€‚</div>

        <div class="row" style="margin-top:10px;">
          <label class="chip">
            <input id="burnEnable" type="checkbox" />
            <b>å•Ÿç”¨ç‡’ç‰Œ</b>
          </label>

          <button id="btnBurnNow" class="ghost">ç«‹å³ç‡’ç‰Œï¼ˆé‡æ–°æŠ½ï¼‰</button>
          <span class="tag">å·²ç‡’ï¼š<span id="burnedCount" class="mono">0</span> å¼µ</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <span class="tag">ç‡’ç‰Œç‰Œé¢ï¼š<span id="burnCard" class="mono">â€”</span></span>
          <span class="tag">ç‡’ç‰Œæ•¸ï¼š<span id="burnN" class="mono">â€”</span></span>
        </div>

        <div style="margin-top:10px;">
          <div class="muted small">ç‡’æ‰çš„ç‰Œï¼ˆåƒ…é¡¯ç¤ºï¼Œä¸å¯é€†ï¼›è¦é‡ä¾†è«‹æŒ‰ã€Œé‡ç½®ç‰Œé´ã€ï¼‰ï¼š</div>
          <div id="burnedList" class="mono list">ï¼ˆå°šæœªç‡’ç‰Œï¼‰</div>
        </div>

        <div class="hr"></div>

        <div class="big"><b>æ­¥é©Ÿ 1ï¼šæŒ‰éˆ•è¼¸å…¥ã€Œå·²é–‹éçš„ç‰Œã€</b></div>
        <div class="muted small">é»ä¸‹æ–¹ç‰Œé¢å°±åŠ å…¥åˆ°ã€Œæœ¬è¼ªæš«å­˜ã€ã€‚å¦‚æœä¸€æ¬¡è¦åŠ å¤šå¼µï¼Œå…ˆé¸ã€Œæ•¸é‡ã€ã€‚</div>

        <div class="row" style="margin-top:10px;">
          <span class="chip">æ•¸é‡ï¼š
            <select id="qty">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
          </span>

          <button id="btnUndoOne" class="ghost">é€€ä¸€å¼µ</button>
          <button id="btnUndo" class="ghost">æ¸…ç©ºæœ¬è¼ªæš«å­˜ï¼ˆEscï¼‰</button>
        </div>

        <!-- æŒ‰éˆ•éµç›¤ -->
        <div class="kpad" aria-label="card keypad">
          <button class="kbtn" data-r="A">A</button>
          <button class="kbtn" data-r="2">2</button>
          <button class="kbtn" data-r="3">3</button>
          <button class="kbtn" data-r="4">4</button>
          <button class="kbtn" data-r="5">5</button>
          <button class="kbtn" data-r="6">6</button>
          <button class="kbtn" data-r="7">7</button>

          <button class="kbtn" data-r="8">8</button>
          <button class="kbtn" data-r="9">9</button>
          <button class="kbtn kbtn10" data-r="10">10</button>
          <button class="kbtn" data-r="J">J</button>
          <button class="kbtn" data-r="Q">Q</button>
          <button class="kbtn" data-r="K">K</button>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnCompute" class="primary">è¨ˆç®—ä¸‹ä¸€å±€ï¼ˆMï¼‰</button>
          <button id="btnReset" class="danger">é‡ç½®ç‰Œé´ï¼ˆRï¼‰</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <label>æ¨¡æ“¬æ¬¡æ•¸ï¼š</label>
          <input id="trials" type="number" min="1000" step="1000" value="200000" />
          <select id="preset">
            <option value="">å¿«é€Ÿé¸æ“‡</option>
            <option value="50000">50,000ï¼ˆå¿«ï¼‰</option>
            <option value="200000">200,000ï¼ˆå¹³è¡¡ï¼‰</option>
            <option value="500000">500,000ï¼ˆç©©ï¼‰</option>
            <option value="1000000">1,000,000ï¼ˆæ›´ç©©ï¼‰</option>
          </select>
          <button id="btnExport">åŒ¯å‡ºç‹€æ…‹ JSON</button>
          <button id="btnImport">åŒ¯å…¥ç‹€æ…‹ JSON</button>
        </div>

        <div id="msg" style="margin-top:10px;"></div>

        <div style="margin-top:10px;">
          <div class="muted small">è¨ˆç®—é€²åº¦ï¼ˆå¤§æ¬¡æ•¸æ™‚æœƒé¡¯ç¤ºï¼‰ï¼š</div>
          <div class="progress"><div id="bar" class="bar"></div></div>
        </div>

        <!-- ä»ä¿ç•™ï¼šé€²éšæ‰‹å‹•è²¼ä¸Šï¼ˆå¯ä¸ä½¿ç”¨ï¼‰ -->
        <div class="hr"></div>
        <details>
          <summary class="muted">é€²éšï¼šæ‰‹å‹•è²¼ä¸Šç‰Œï¼ˆå¯å¿½ç•¥èŠ±è‰²ï¼‰</summary>
          <textarea id="inputCards" placeholder="ä¾‹å¦‚ï¼šAâ™  10H KD 3d, 7c ...ï¼ˆèŠ±è‰²æœƒè‡ªå‹•å¿½ç•¥ï¼‰"></textarea>
          <div class="row" style="margin-top:10px;">
            <button id="btnAddFromText">æŠŠè²¼ä¸Šçš„ç‰ŒåŠ å…¥æš«å­˜</button>
          </div>
        </details>
      </div>

      <!-- å³ -->
      <div>
        <div class="big"><b>æœ¬è¼ªæš«å­˜ï¼ˆå°šæœªæ‰£é™¤ï¼‰</b></div>
        <div id="buffer" class="mono list"></div>

        <div class="hr"></div>

        <div class="big"><b>ç‹€æ…‹</b></div>
        <div>å›åˆï¼š<span id="roundNo" class="mono"></span></div>
        <div>å‰©é¤˜å¼µæ•¸ï¼š<span id="remain" class="mono"></span></div>

        <div class="hr"></div>

        <div class="big"><b>æ‰£ç‰Œå¾Œå„é»æ•¸å¼µæ•¸</b></div>
        <div id="shoeCounts" class="mono list"></div>

        <div class="hr"></div>

        <div class="big"><b>æ­·å²ç´€éŒ„</b></div>
        <div id="history" class="mono list"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- å¸¸æ•¸ ----------
  const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  const IDX = new Map(RANKS.map((r,i)=>[r,i]));
  const MAX_DRAW = 6;

  // ---------- ç‰Œé´ ----------
  function newShoeCounts(nDecks=8){
    const counts = new Int16Array(RANKS.length);
    for(let i=0;i<counts.length;i++) counts[i] = 4*nDecks;
    return counts;
  }
  function shoeSize(counts){
    let s=0; for(let i=0;i<counts.length;i++) s+=counts[i]; return s;
  }
  function formatCounts(counts){
    return RANKS.map((r,i)=>`${r}:${counts[i]}`).join("  ");
  }

  // ---------- WebCrypto RNGï¼šå‡å‹»æ•´æ•¸ ----------
  function randIntBelow(n){
    const max = 0x100000000;
    const limit = max - (max % n);
    const buf = new Uint32Array(1);
    while(true){
      crypto.getRandomValues(buf);
      const x = buf[0];
      if(x < limit) return x % n;
    }
  }

  // ---------- å¾ counts éš¨æ©ŸæŠ½ 1 å¼µï¼ˆä¸å±•é–‹ deckï¼Œçµ¦ç‡’ç‰Œç”¨ï¼‰ ----------
  function drawOneFromCounts(counts){
    const total = shoeSize(counts);
    if(total <= 0) throw new Error("ç‰Œé´å·²ç©ºï¼Œç„¡æ³•æŠ½ç‰Œã€‚");
    const k = randIntBelow(total); // 0..total-1
    let acc = 0;
    for(let i=0;i<counts.length;i++){
      const c = counts[i];
      if(c <= 0) continue;
      if(k < acc + c){
        counts[i]--;
        return RANKS[i];
      }
      acc += c;
    }
    // ç†è«–ä¸Šä¸æœƒåˆ°é€™
    throw new Error("æŠ½ç‰Œå¤±æ•—ï¼ˆè¨ˆç®—éŒ¯èª¤ï¼‰ã€‚");
  }

  // ---------- è¼¸å…¥è§£æï¼ˆé€²éšè²¼ä¸Šç”¨ï¼šå¿½ç•¥èŠ±è‰²/ç¬¦è™Ÿ/æ›è¡Œï¼‰ ----------
  function normalizeToken(tok){
    let t = tok.trim().toUpperCase();
    if(!t) return null;
    t = t.replace(/[â™ â™¥â™¦â™£SHDC]/g, "");
    t = t.replace(/[^A-Z0-9]/g, "");
    if(t === "1") t = "A";
    if(t === "T") t = "10";
    if(IDX.has(t)) return t;
    return null;
  }
  function parseCards(text){
    const raw = text.replace(/,/g," ").replace(/\n/g," ").trim();
    if(!raw) return [];
    const toks = raw.split(/\s+/);
    const out = [];
    for(const tok of toks){
      const t = normalizeToken(tok);
      if(!t) throw new Error(`ä¸èªå¾—çš„ç‰Œï¼š${tok}ï¼ˆè«‹ç”¨ A 2-10 J Q Kï¼›å¯å¸¶èŠ±è‰²ï¼‰`);
      out.push(t);
    }
    return out;
  }

  function removeCardsFromShoe(counts, cards){
    for(const r of cards){
      const i = IDX.get(r);
      if(counts[i] <= 0) throw new Error(`ç‰Œé´è£¡ ${r} å·²ç¶“æ²’äº†ï¼Œä¸èƒ½å†æ‰£ã€‚`);
      counts[i]--;
    }
  }

  // ---------- ç™¾å®¶æ¨‚é»æ•¸ ----------
  function rankValue(rank){
    if(rank==="A") return 1;
    if(rank==="10"||rank==="J"||rank==="Q"||rank==="K") return 0;
    return Number(rank);
  }
  function burnValue(rank){
    // ç‡’ç‰Œç”¨ï¼šA=1ï¼Œ2-9=åŒé»æ•¸ï¼Œ10/J/Q/K=10
    if(rank==="A") return 1;
    if(rank==="10"||rank==="J"||rank==="Q"||rank==="K") return 10;
    return Number(rank);
  }
  function handTotal(cards){
    let s=0; for(const r of cards) s += rankValue(r);
    return s % 10;
  }

  // ---------- è£œç‰Œè¦å‰‡ ----------
  function playOneRoundFromDraw(draw6){
    const p = [draw6[0], draw6[1]];
    const b = [draw6[2], draw6[3]];
    let pt = handTotal(p);
    let bt = handTotal(b);

    if(pt===8||pt===9||bt===8||bt===9){
      if(pt>bt) return 0;
      if(bt>pt) return 1;
      return 2;
    }

    let idx = 4;
    let pThird = null;

    if(pt <= 5){
      pThird = draw6[idx++]; p.push(pThird);
      pt = handTotal(p);
    }

    bt = handTotal(b);
    if(pThird === null){
      if(bt <= 5){
        b.push(draw6[idx++]);
        bt = handTotal(b);
      }
    }else{
      const pv = rankValue(pThird);
      if(bt <= 2){
        b.push(draw6[idx++]);
      }else if(bt === 3 && pv !== 8){
        b.push(draw6[idx++]);
      }else if(bt === 4 && (pv>=2 && pv<=7)){
        b.push(draw6[idx++]);
      }else if(bt === 5 && (pv>=4 && pv<=7)){
        b.push(draw6[idx++]);
      }else if(bt === 6 && (pv===6 || pv===7)){
        b.push(draw6[idx++]);
      }
      bt = handTotal(b);
    }

    if(pt>bt) return 0;
    if(bt>pt) return 1;
    return 2;
  }

  // ---------- å±•é–‹ deckï¼ˆæ¨¡æ“¬ç”¨ï¼‰ ----------
  function expandDeckFromCounts(counts){
    const deck = [];
    for(let i=0;i<counts.length;i++){
      for(let k=0;k<counts[i];k++) deck.push(RANKS[i]);
    }
    return deck;
  }
  function draw6FastInPlace(deck, swapsJ){
    const n = deck.length;
    for(let i=0;i<MAX_DRAW;i++){
      const j = i + randIntBelow(n - i);
      swapsJ[i] = j;
      const tmp = deck[i]; deck[i] = deck[j]; deck[j] = tmp;
    }
    return [deck[0],deck[1],deck[2],deck[3],deck[4],deck[5]];
  }
  function restoreDeck(deck, swapsJ){
    for(let i=MAX_DRAW-1;i>=0;i--){
      const j = swapsJ[i];
      const tmp = deck[i]; deck[i] = deck[j]; deck[j] = tmp;
    }
  }

  // ---------- è’™åœ°å¡ç¾…ä¼°è¨ˆ ----------
  function estimateProbs(counts, trials, onProgress){
    const m = shoeSize(counts);
    if(m < 6) throw new Error("å‰©é¤˜ç‰Œä¸è¶³ä»¥æ¨¡æ“¬ï¼ˆè‡³å°‘è¦ >=6 å¼µï¼‰ã€‚");

    const deck = expandDeckFromCounts(counts);
    const swapsJ = new Int32Array(MAX_DRAW);

    let pw=0, bw=0, tw=0;
    const step = Math.max(5000, Math.floor(trials / 200));

    for(let k=1;k<=trials;k++){
      const draw6 = draw6FastInPlace(deck, swapsJ);
      const out = playOneRoundFromDraw(draw6);
      if(out===0) pw++;
      else if(out===1) bw++;
      else tw++;

      restoreDeck(deck, swapsJ);

      if(onProgress && (k % step === 0 || k === trials)){
        onProgress(k / trials);
      }
    }

    const total = pw+bw+tw;
    return [pw/total, bw/total, tw/total];
  }

  // ---------- EV å»ºè­°ä¸‹æ³¨ ----------
  function calcRecommendation(p, b, t){
    // å¸¸è¦‹è¦å‰‡ï¼šé–’ 1:1ï¼ŒèŠ 1:1 æŠ½ 5%ï¼Œå’Œ 8:1
    const evP = p - b;
    const evB = 0.95 * b - p;
    const evT = 8 * t - (1 - t);

    let bestSide = "é–’";
    let bestEV = evP;
    if(evB > bestEV){ bestEV = evB; bestSide = "èŠ"; }
    if(evT > bestEV){ bestEV = evT; bestSide = "å’Œ"; }

    if(bestEV < 0) bestSide = "ä¸ä¸‹";
    return { side: bestSide, evP, evB, evT, bestEV };
  }

  // ---------- URL å¸¶å…¥ cards ----------
  function getParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  function parseCardsFromParam(cardsParam){
    if(!cardsParam) return [];
    const cleaned = cardsParam.replace(/[|]/g, " ").replace(/,/g, " ").trim();
    if(!cleaned) return [];
    return parseCards(cleaned);
  }

  // ---------- UI ç‹€æ…‹ ----------
  let shoe = newShoeCounts(8);
  let buffer = [];
  let roundNo = 1;
  let history = []; // {round, remain, trials, p,b,t}

  // ç‡’ç‰Œç‹€æ…‹
  let burnEnabled = false;
  let burned = [];      // ç‡’æ‰çš„ç‰Œï¼ˆå«ç‡’ç‰Œç‰Œé¢ + å¾ŒçºŒç‡’æ‰ï¼‰
  let burnCard = null;  // ç‡’ç‰Œç‰Œé¢
  let burnN = 0;        // ä¾ç‡’ç‰Œè¨ˆç®—å‡ºçš„ã€Œå¾ŒçºŒç‡’ç‰Œæ•¸ã€

  // ---------- UI å…ƒä»¶ ----------
  const elTrials = document.getElementById("trials");
  const elPreset = document.getElementById("preset");
  const elMsg = document.getElementById("msg");
  const elBuffer = document.getElementById("buffer");
  const elRound = document.getElementById("roundNo");
  const elRemain = document.getElementById("remain");
  const elCounts = document.getElementById("shoeCounts");
  const elP = document.getElementById("pProb");
  const elB = document.getElementById("bProb");
  const elT = document.getElementById("tProb");
  const elRec = document.getElementById("rec");
  const elRec2 = document.getElementById("rec2");
  const elHist = document.getElementById("history");
  const elBar = document.getElementById("bar");

  const elBurnEnable = document.getElementById("burnEnable");
  const elBurnedCount = document.getElementById("burnedCount");
  const elBurnCard = document.getElementById("burnCard");
  const elBurnN = document.getElementById("burnN");
  const elBurnedList = document.getElementById("burnedList");

  const elQty = document.getElementById("qty");
  const elInput = document.getElementById("inputCards");

  function setMsg(text, kind="muted"){
    elMsg.className = kind;
    elMsg.textContent = text;
  }
  function pct(x){ return (x*100).toFixed(4) + "%"; }
  function resetProgress(){ elBar.style.width = "0%"; }
  function setProgress(frac){ elBar.style.width = `${Math.max(0,Math.min(1,frac))*100}%`; }

  function render(){
    elRound.textContent = String(roundNo);
    elRemain.textContent = String(shoeSize(shoe));
    elCounts.textContent = formatCounts(shoe);

    elBuffer.textContent = buffer.length ? buffer.join(" ") : "ï¼ˆç©ºï¼‰";

    // ç‡’ç‰Œé¡¯ç¤º
    elBurnedCount.textContent = String(burned.length);
    elBurnCard.textContent = burnCard ? burnCard : "â€”";
    elBurnN.textContent = burnEnabled ? String(burnN) : "â€”";
    elBurnedList.textContent = burned.length ? burned.join(" ") : "ï¼ˆå°šæœªç‡’ç‰Œï¼‰";

    if(history.length === 0){
      elHist.textContent = "ï¼ˆå°šç„¡ç´€éŒ„ï¼‰";
    }else{
      elHist.textContent = history.slice().reverse().map(h =>
        `#${h.round}  remain=${h.remain}  trials=${h.trials}  P=${pct(h.p)}  B=${pct(h.b)}  T=${pct(h.t)}`
      ).join("\n");
    }
  }

  // ---------- localStorage è‡ªå‹•ä¿å­˜/è¼‰å…¥ ----------
  const SAVE_KEY = "baccarat_mc_pro_state_v2_burn_keypad";

  function saveState(){
    try{
      const obj = {
        roundNo,
        shoe: Array.from(shoe),
        buffer: buffer.slice(),
        history: history.slice(),
        trials: Number(elTrials.value) || 200000,

        // çµæœé¡¯ç¤º
        pProb: elP.textContent,
        bProb: elB.textContent,
        tProb: elT.textContent,
        rec: elRec.textContent,
        rec2: elRec2.textContent,

        // ç‡’ç‰Œ
        burnEnabled,
        burned,
        burnCard,
        burnN,

        // UI
        qty: Number(elQty.value) || 1
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(obj));
    }catch(_e){}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return false;
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.shoe) || obj.shoe.length !== RANKS.length) return false;

      shoe = new Int16Array(obj.shoe.map(Number));
      roundNo = Number(obj.roundNo || 1);
      buffer = Array.isArray(obj.buffer) ? obj.buffer.map(String) : [];
      history = Array.isArray(obj.history) ? obj.history : [];
      if(obj.trials) elTrials.value = String(obj.trials);

      if(obj.pProb) elP.textContent = obj.pProb;
      if(obj.bProb) elB.textContent = obj.bProb;
      if(obj.tProb) elT.textContent = obj.tProb;
      if(obj.rec) elRec.textContent = obj.rec;
      if(obj.rec2) elRec2.textContent = obj.rec2;

      burnEnabled = !!obj.burnEnabled;
      burned = Array.isArray(obj.burned) ? obj.burned.map(String) : [];
      burnCard = obj.burnCard ? String(obj.burnCard) : null;
      burnN = Number(obj.burnN || 0);

      elBurnEnable.checked = burnEnabled;

      if(obj.qty) elQty.value = String(obj.qty);

      return true;
    }catch(_e){
      return false;
    }
  }

  // ---------- ç‡’ç‰Œæµç¨‹ ----------
  function doBurn(){
    if(!burnEnabled){
      burned = [];
      burnCard = null;
      burnN = 0;
      render();
      saveState();
      return;
    }
    // é‡æ–°ç‡’ç‰Œå‰ï¼šå…ˆæŠŠå·²ç‡’çš„ã€Œå›è£œã€ä¸åšï¼ˆé¿å…è¤‡é›œï¼‰ï¼Œæ‰€ä»¥æ­¤æŒ‰éˆ•å»ºè­°åªåœ¨ã€Œå‰›é‡ç½®ç‰Œé´ã€æ™‚ç”¨ã€‚
    // æˆ‘é€™è£¡æ¡å–ï¼šç›´æ¥é‡ç½®ç‰Œé´å¾Œå†ç‡’ç‰Œæœ€ä¹¾æ·¨ã€‚
    // è‹¥ä½ ç¡¬è¦åœ¨ä¸­é€”é‡ç‡’ï¼Œæœƒé€ æˆä¸ä¸€è‡´ã€‚
    // æ‰€ä»¥ï¼šä¸­é€”æŒ‰æœƒæç¤ºä½ ç”¨ã€Œé‡ç½®ç‰Œé´ã€ã€‚
    if(shoeSize(shoe) !== 8*52){
      setMsg("âš ï¸ å»ºè­°ï¼šç‡’ç‰Œè«‹åœ¨ã€Œé‡ç½®ç‰Œé´ã€å¾Œç«‹åˆ»åšï¼ˆé¿å…ä¸­é€”é‡ç‡’é€ æˆä¸ä¸€è‡´ï¼‰ã€‚", "warn");
      return;
    }

    burned = [];
    burnCard = null;
    burnN = 0;

    // æŠ½ç‡’ç‰Œç‰Œé¢
    burnCard = drawOneFromCounts(shoe);
    burnN = burnValue(burnCard);

    burned.push(burnCard);

    // å†ç‡’ N å¼µ
    for(let i=0;i<burnN;i++){
      if(shoeSize(shoe) <= 0) break;
      burned.push(drawOneFromCounts(shoe));
    }

    setMsg(`âœ… å·²ç‡’ç‰Œï¼šç‡’ç‰Œç‰Œé¢ ${burnCard}ï¼Œå†ç‡’ ${burnN} å¼µï¼ˆå…± ${burned.length} å¼µï¼‰ã€‚`, "ok");
    render();
    saveState();
  }

  // ---------- è¡Œç‚ºï¼šæŒ‰éˆ•åŠ å…¥ç‰Œ ----------
  function addRankToBuffer(rank, n){
    try{
      const qty = Math.max(1, Math.min(20, Number(n||1)));
      for(let i=0;i<qty;i++) buffer.push(rank);
      setMsg(`å·²åŠ å…¥ ${rank} Ã— ${qty}ï¼ˆæœ¬è¼ªæš«å­˜å…± ${buffer.length} å¼µï¼‰`, "ok");
      render();
      saveState();
    }catch(e){
      setMsg(e.message || String(e), "warn");
    }
  }

  function undoOne(){
    if(buffer.length){
      const x = buffer.pop();
      setMsg(`å·²é€€ä¸€å¼µï¼š${x}ï¼ˆæœ¬è¼ªæš«å­˜å‰© ${buffer.length} å¼µï¼‰`, "ok");
      render();
      saveState();
    }else{
      setMsg("æœ¬è¼ªæš«å­˜æ˜¯ç©ºçš„ã€‚", "muted");
    }
  }

  function clearBuffer(){
    buffer = [];
    setMsg("å·²æ¸…ç©ºæœ¬è¼ªæš«å­˜ã€‚", "ok");
    render();
    saveState();
  }

  // ---------- è¡Œç‚ºï¼šé€²éšè²¼ä¸ŠåŠ å…¥ ----------
  function addBufferFromText(){
    try{
      const cards = parseCards(elInput.value);
      if(cards.length===0){ setMsg("è«‹å…ˆè²¼ä¸Šç‰Œå†åŠ å…¥ã€‚", "warn"); return; }
      buffer.push(...cards);
      elInput.value = "";
      setMsg(`å·²å¾è²¼ä¸ŠåŠ å…¥ ${cards.length} å¼µï¼ˆæœ¬è¼ªæš«å­˜å…± ${buffer.length} å¼µï¼‰ã€‚`, "ok");
      render();
      saveState();
    }catch(e){
      setMsg(e.message, "warn");
    }
  }

  // ---------- è¡Œç‚ºï¼šè¨ˆç®—ä¸‹ä¸€å±€ ----------
  function computeNext(){
    try{
      resetProgress();
      const trials = Number(elTrials.value);
      if(!Number.isFinite(trials) || trials < 1000){
        setMsg("æ¨¡æ“¬æ¬¡æ•¸è«‹è¼¸å…¥ >= 1000 çš„æ•¸å­—ã€‚", "warn"); return;
      }

      // æ‰£ç‰Œï¼ˆæ‰£æ‰æœ¬è¼ªçœ‹åˆ°çš„ç‰Œï¼‰
      if(buffer.length){
        removeCardsFromShoe(shoe, buffer);
      }
      buffer = [];

      const remain = shoeSize(shoe);
      if(remain < 6){
        setMsg("å‰©é¤˜ç‰Œä¸è¶³ä»¥æ¨¡æ“¬ä¸‹ä¸€å±€ï¼ˆ<6 å¼µï¼‰ï¼Œå·²åœæ­¢ã€‚", "warn");
        render();
        saveState();
        return;
      }

      setMsg("è¨ˆç®—ä¸­â€¦ï¼ˆPRO å¿«é€Ÿç‰ˆï¼‰", "muted");
      render();
      saveState();

      setTimeout(() => {
        try{
          const [p,b,t] = estimateProbs(shoe, trials, frac => setProgress(frac));
          elP.textContent = pct(p);
          elB.textContent = pct(b);
          elT.textContent = pct(t);

          const r = calcRecommendation(p,b,t);
          elRec.textContent = r.side;
          elRec2.textContent = `EV(é–’)=${(r.evP*100).toFixed(3)}%  EV(èŠ)=${(r.evB*100).toFixed(3)}%  EV(å’Œ)=${(r.evT*100).toFixed(3)}%`;

          history.push({round: roundNo, remain, trials, p,b,t});
          setMsg(`å®Œæˆï¼šå·²æ‰£é™¤æœ¬è¼ªå·²é–‹ç‰Œä¸¦ä¼°è¨ˆä¸‹ä¸€å±€å‹ç‡ï¼ˆ${trials.toLocaleString()} æ¬¡ï¼‰ã€‚`, "ok");

          roundNo++;
          render();
          saveState();
          // è¨ˆç®—å®Œè‡ªå‹•æ»¾åˆ°é ‚ï¼ˆç¢ºä¿ä½ ç«‹åˆ»çœ‹åˆ°çµæœï¼‰
          window.scrollTo({top:0, behavior:"smooth"});
        }catch(e){
          setMsg(e.message || String(e), "warn");
          render();
          saveState();
        }
      }, 30);

    }catch(e){
      setMsg(e.message || String(e), "warn");
    }
  }

  function resetAll(){
    shoe = newShoeCounts(8);
    buffer = [];
    roundNo = 1;
    history = [];

    // çµæœæ¸…ç©º
    elP.textContent = elB.textContent = elT.textContent = "â€”";
    elRec.textContent = "â€”";
    elRec2.textContent = "";
    resetProgress();

    // ç‡’ç‰Œæ¸…ç©ºï¼ˆä½†ä¿ç•™ã€Œå•Ÿç”¨ã€é–‹é—œï¼‰
    burned = [];
    burnCard = null;
    burnN = 0;

    setMsg("å·²é‡ç½®ç‚º 8 å‰¯ç‰Œæ–°ç‰Œé´ã€‚è‹¥å•Ÿç”¨ç‡’ç‰Œï¼Œè«‹æŒ‰ã€Œç«‹å³ç‡’ç‰Œã€ã€‚", "ok");
    render();
    saveState();
  }

  // ---------- åŒ¯å‡º/åŒ¯å…¥ ----------
  function exportState(){
    const obj = {
      version: "baccarat-mc-pro-2",
      roundNo,
      shoe: Array.from(shoe),
      buffer: buffer.slice(),
      history: history.slice(),
      trials: Number(elTrials.value) || 200000,

      burnEnabled,
      burned,
      burnCard,
      burnN
    };
    const json = JSON.stringify(obj, null, 2);
    window.prompt("è¤‡è£½ä»¥ä¸‹ JSONï¼ˆå¯è²¼åˆ°è¨˜äº‹æœ¬ä¿å­˜ï¼‰ï¼š", json);
    saveState();
  }

  function importState(){
    const json = window.prompt("è²¼ä¸Šå…ˆå‰åŒ¯å‡ºçš„ JSONï¼š");
    if(!json) return;
    try{
      const obj = JSON.parse(json);
      if(!obj || !obj.shoe || !Array.isArray(obj.shoe) || obj.shoe.length !== RANKS.length){
        throw new Error("JSON æ ¼å¼ä¸æ­£ç¢ºï¼ˆç¼ºå°‘ shoe æˆ–é•·åº¦ä¸å°ï¼‰ã€‚");
      }
      shoe = new Int16Array(obj.shoe.map(x => Number(x)));
      roundNo = Number(obj.roundNo || 1);
      buffer = Array.isArray(obj.buffer) ? obj.buffer.map(String) : [];
      history = Array.isArray(obj.history) ? obj.history : [];
      if(obj.trials) elTrials.value = String(obj.trials);

      burnEnabled = !!obj.burnEnabled;
      burned = Array.isArray(obj.burned) ? obj.burned.map(String) : [];
      burnCard = obj.burnCard ? String(obj.burnCard) : null;
      burnN = Number(obj.burnN || 0);
      elBurnEnable.checked = burnEnabled;

      setMsg("å·²åŒ¯å…¥ç‹€æ…‹ã€‚", "ok");
      render();
      saveState();
    }catch(e){
      setMsg("åŒ¯å…¥å¤±æ•—ï¼š" + (e.message || String(e)), "warn");
    }
  }

  // ---------- URL è‡ªå‹•åŠ å…¥ cards ----------
  function autoImportFromURL(){
    const cardsParam = getParam("cards");
    const auto = getParam("auto"); // auto=1 è‡ªå‹•è¨ˆç®—
    if(!cardsParam) return;

    try{
      const cards = parseCardsFromParam(cardsParam);
      if(cards.length === 0) return;

      buffer.push(...cards);
      setMsg(`å·²å¾ç¶²å€è‡ªå‹•åŠ å…¥ ${cards.length} å¼µï¼š${cards.join(" ")}`, "ok");
      render();
      saveState();

      if(auto === "1"){
        computeNext();
      }
    }catch(e){
      setMsg("ç¶²å€å¸¶å…¥å¤±æ•—ï¼š" + (e.message || String(e)), "warn");
    }
  }

  // ---------- ç¶å®šäº‹ä»¶ ----------
  // ç‰Œé¢æŒ‰éˆ•
  document.querySelectorAll("[data-r]").forEach(btn => {
    btn.addEventListener("click", () => {
      const r = btn.getAttribute("data-r");
      const q = Number(elQty.value) || 1;
      addRankToBuffer(r, q);
    });
  });

  document.getElementById("btnUndoOne").addEventListener("click", undoOne);
  document.getElementById("btnUndo").addEventListener("click", clearBuffer);
  document.getElementById("btnCompute").addEventListener("click", computeNext);
  document.getElementById("btnReset").addEventListener("click", resetAll);

  document.getElementById("btnExport").addEventListener("click", exportState);
  document.getElementById("btnImport").addEventListener("click", importState);

  document.getElementById("btnAddFromText").addEventListener("click", addBufferFromText);

  elPreset.addEventListener("change", () => {
    if(elPreset.value){
      elTrials.value = elPreset.value;
      setMsg(`å·²å¥—ç”¨æ¨¡æ“¬æ¬¡æ•¸ï¼š${Number(elPreset.value).toLocaleString()}`, "ok");
      saveState();
    }
    elPreset.value = "";
  });

  elQty.addEventListener("change", saveState);

  // ç‡’ç‰Œ
  elBurnEnable.addEventListener("change", () => {
    burnEnabled = elBurnEnable.checked;
    if(!burnEnabled){
      burned = [];
      burnCard = null;
      burnN = 0;
      setMsg("å·²é—œé–‰ç‡’ç‰Œï¼ˆä¸æœƒæ‰£é™¤ç‡’ç‰Œï¼‰ã€‚", "ok");
      render();
      saveState();
      return;
    }
    setMsg("å·²å•Ÿç”¨ç‡’ç‰Œï¼šè«‹æŒ‰ã€Œç«‹å³ç‡’ç‰Œï¼ˆé‡æ–°æŠ½ï¼‰ã€ä¾†æ‰£é™¤ç‡’ç‰Œã€‚", "ok");
    render();
    saveState();
  });

  document.getElementById("btnBurnNow").addEventListener("click", () => {
    doBurn();
  });

  // å…¨åŸŸå¿«æ·éµï¼šM / R / Esc
  window.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){ clearBuffer(); }
    else if(e.key.toUpperCase() === "M"){ computeNext(); }
    else if(e.key.toUpperCase() === "R"){ resetAll(); }
  });

  // ---------- åˆå§‹ ----------
  const loaded = loadState();
  render();
  autoImportFromURL();

  if(loaded){
    setMsg("å·²å¾æœ¬æ©Ÿè‡ªå‹•è¼‰å…¥ä¸Šæ¬¡ç‹€æ…‹ï¼ˆlocalStorageï¼‰ã€‚", "ok");
  }else{
    setMsg("æº–å‚™å°±ç·’ï¼šå…ˆï¼ˆå¯é¸ï¼‰ç‡’ç‰Œ â†’ ç”¨æŒ‰éˆ•æŠŠå·²é–‹éçš„ç‰Œæ‰£æ‰ â†’ æŒ‰ M è¨ˆç®—ä¸‹ä¸€å±€ã€‚", "ok");
  }
})();
</script>
</body>
</html>