<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ç™¾å®¶æ¨‚å‹ç‡ PROï¼ˆ8å‰¯ç‰Œï½œæ‰£ç‰Œï½œç‡’ç‰Œï½œè’™åœ°å¡ç¾…ï½œç‰Œè·¯å…¨ï¼‰</title>
  <style>
    :root{
      --fg:#111; --muted:#666; --warn:#b00020; --ok:#0b6;
      --bd:#e6e6e6; --bg:#fff; --soft:#fafafa;
      --card:12px;

      /* æ¨™æº–è³­å ´è‰² */
      --P:#1976d2;      /* é–’ï¼šè— */
      --B:#d32f2f;      /* èŠï¼šç´… */
      --T:#2e7d32;      /* å’Œï¼šç¶  */
      --DR:#d32f2f;     /* æ´¾ç”Ÿè·¯ï¼šç´… */
      --DB:#1976d2;     /* æ´¾ç”Ÿè·¯ï¼šè— */
    }

    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
      margin:16px; line-height:1.35; color:var(--fg); background:var(--bg);
      padding-bottom: 92px; /* sticky bar */
    }
    h1{margin:0 0 8px; font-size:1.55rem;}
    .muted{color:var(--muted);}
    .warn{color:var(--warn);}
    .ok{color:var(--ok);}
    .small{font-size:.92rem;}
    .big{font-size:1.15rem;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

    .card{
      border:1px solid var(--bd); border-radius:var(--card);
      padding:14px; margin-top:12px; background:#fff;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .hr{height:1px; background:var(--bd); margin:12px 0;}

    button, input, select {font:inherit;}
    button{
      border:1px solid var(--bd); background:#fff; color:var(--fg);
      border-radius:12px; padding:12px 12px; cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{transform: translateY(1px);}
    button.primary{background:#111; color:#fff; border-color:#111;}
    button.danger{border-color:var(--warn); color:var(--warn);}
    button.soft{background:var(--soft);}
    input[type="number"]{
      padding:10px 12px; border-radius:12px; border:1px solid var(--bd); width:160px;
    }
    select{
      padding:10px 12px; border-radius:12px; border:1px solid var(--bd);
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--bd); background:var(--soft);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:.92rem;
      max-width:100%;
    }
    .pill button{
      padding:4px 8px; border-radius:999px; border:1px solid var(--bd);
    }

    .list{
      border:1px solid var(--bd); border-radius:12px; padding:10px; background:var(--soft);
      max-height:260px; overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:.92rem;
      white-space: pre-wrap;
    }

    .progress{height:10px; background:#eee; border-radius:999px; overflow:hidden;}
    .bar{height:100%; width:0%; background:#111;}

    /* Sticky top result */
    .sticky-result{
      position: sticky;
      top: 0;
      z-index: 100;
      background: #ffffff;
      box-shadow: 0 6px 12px rgba(0,0,0,0.06);
    }
    @media (max-width: 600px){
      .sticky-result{
        border-radius: 0;
        margin: 0 -16px 12px -16px;
      }
    }

    /* Layout */
    .twoCol{display:grid; grid-template-columns:1fr; gap:12px;}
    @media (min-width:900px){ .twoCol{grid-template-columns: 1.15fr .85fr;} }

    .grid4{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px;}
    @media (min-width:720px){ .grid4{grid-template-columns: repeat(4, minmax(0,1fr));} }

    /* Rank buttons */
    .rankGrid{display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:10px;}
    @media (max-width:520px){ .rankGrid{grid-template-columns: repeat(5, minmax(0,1fr));} }
    button.rank{
      padding:10px 8px; border-radius:14px;
      display:flex; flex-direction:column; gap:4px; align-items:center; justify-content:center;
      min-height:56px;
    }
    .rank .r{font-weight:800; font-size:1.05rem;}
    .rank .c{font-size:.8rem; color:var(--muted);}

    /* Sticky action bar */
    .sticky{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,.95);
      border-top:1px solid var(--bd);
      backdrop-filter: blur(10px);
    }
    .sticky .wrap{
      max-width:980px; margin:0 auto;
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .sticky .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .sticky .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .k{padding:2px 8px; border:1px solid var(--bd); border-bottom-width:2px; border-radius:8px; background:var(--soft); font-family:ui-monospace,monospace;}

    /* Roads */
    .roadsWrap{display:grid; grid-template-columns:1fr; gap:12px;}
    @media (min-width: 980px){ .roadsWrap{grid-template-columns: 1fr 1fr;} }
    .roadBox{border:1px solid var(--bd); border-radius:12px; padding:12px; background:#fcfcfc;}
    .roadTitle{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;}
    .roadGrid{
      display:grid;
      grid-template-rows: repeat(6, 20px);
      grid-auto-columns: 20px;
      grid-auto-flow: column;
      gap:4px;
      align-items:center;
    }
    .cell{
      width:20px; height:20px;
      border:1px solid #e6e6e6;
      border-radius:6px;
      background:#fff;
      position:relative;
      overflow:hidden;
    }
    .dot{
      position:absolute;
      inset:3px;
      border-radius:999px;
      background:#999;
    }
    .dot.P{background:var(--P);}
    .dot.B{background:var(--B);}
    .dot.T{background:var(--T);} /* bead tie */
    .dot.R{background:var(--DR);} /* derived red */
    .dot.U{background:var(--DB);} /* derived blue (U=blUe) */

    .tieBadge{
      position:absolute;
      right:-2px; top:-4px;
      font-size:10px;
      line-height:1;
      padding:2px 4px;
      border-radius:999px;
      background:var(--T);
      color:#fff;
      border:1px solid rgba(0,0,0,0.06);
    }
    .roadLegend{display:flex; gap:10px; flex-wrap:wrap; font-size:12px; color:#666;}
    .sw{display:inline-flex; align-items:center; gap:6px;}
    .sw i{display:inline-block; width:10px; height:10px; border-radius:999px;}
    .sw .p{background:var(--P);}
    .sw .b{background:var(--B);}
    .sw .t{background:var(--T);}
    .sw .r{background:var(--DR);}
    .sw .u{background:var(--DB);}

    .note{
      border-left:4px solid var(--bd);
      padding:10px 12px; background:var(--soft); border-radius:12px;
    }
  </style>
</head>

<body>
  <h1>ç™¾å®¶æ¨‚å‹ç‡ PROï¼ˆ8å‰¯ç‰Œï½œæ‰£ç‰Œï½œç‡’ç‰Œï½œè’™åœ°å¡ç¾…ï½œç‰Œè·¯å…¨ï¼‰</h1>

  <!-- âœ… æœ€ä¸Šæ–¹å›ºå®šçµæœå€ -->
  <div class="card sticky-result">
    <div class="big"><b>ğŸ“Š ä¸‹ä¸€å±€ä¼°è¨ˆæ©Ÿç‡ï¼ˆæ‰£ç‰Œå¾Œ / è’™åœ°å¡ç¾…ï¼‰</b></div>
    <div class="grid4" style="margin-top:10px;">
      <div>
        <div class="muted">é–’ (Player)</div>
        <div id="pProb" class="big mono">â€”</div>
      </div>
      <div>
        <div class="muted">èŠ (Banker)</div>
        <div id="bProb" class="big mono">â€”</div>
      </div>
      <div>
        <div class="muted">å’Œ (Tie)</div>
        <div id="tProb" class="big mono">â€”</div>
      </div>
      <div>
        <div class="muted">EV æœ€é«˜ï¼ˆåƒ…æ•¸å­¸å±•ç¤ºï¼‰</div>
        <div id="rec" class="big mono">â€”</div>
        <div id="rec2" class="muted small"></div>
      </div>
    </div>

    <div class="hr"></div>
    <div id="msg" class="muted small"></div>

    <div style="margin-top:10px;">
      <div class="muted small">è¨ˆç®—é€²åº¦ï¼š</div>
      <div class="progress"><div id="bar" class="bar"></div></div>
    </div>

    <div class="note small muted" style="margin-top:10px;">
      æé†’ï¼šæœ¬é æä¾›çš„æ˜¯ã€Œæ‰£ç‰Œå¾Œæ©Ÿç‡ä¼°è¨ˆã€èˆ‡ã€ŒEV æ•¸å­¸å±•ç¤ºã€ï¼Œä¸ä¿è­‰ç²åˆ©ï¼Œè«‹é‡åŠ›å¨›æ¨‚ã€‚
    </div>
  </div>

  <!-- âœ… ç‰Œè·¯å€ï¼ˆç ç›¤ + å¤§è·¯ + ä¸‰è·¯ï¼‰ -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="big"><b>ğŸ§­ ç‰Œè·¯ï¼ˆç ç›¤ / å¤§è·¯ / å¤§çœ¼ä»” / å°è·¯ / æ›±ç”´ï¼‰</b></div>
      <div class="row">
        <button id="btnUndoRes" class="soft">å¾©åŸä¸Šä¸€ç­†</button>
        <button id="btnClearRes" class="danger">æ¸…ç©ºç‰Œè·¯</button>
      </div>
    </div>
    <div class="muted small" style="margin-top:6px;">
      é–‹çå¾ŒæŒ‰ï¼š<b>è¨˜éŒ„ï¼šé–’ / èŠ / å’Œ</b>ï¼ˆç‰Œè·¯æœƒæ›´æ–°ï¼›ä¸å½±éŸ¿æ‰£ç‰Œï¼Œåªæ˜¯è¨˜éŒ„çµæœï¼‰
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="btnResP">è¨˜éŒ„ï¼šé–’ï¼ˆè—ï¼‰</button>
      <button id="btnResB">è¨˜éŒ„ï¼šèŠï¼ˆç´…ï¼‰</button>
      <button id="btnResT">è¨˜éŒ„ï¼šå’Œï¼ˆç¶ ï¼‰</button>
      <span id="resMsg" class="muted small"></span>
    </div>

    <div class="roadsWrap" style="margin-top:12px;">
      <div class="roadBox">
        <div class="roadTitle">
          <div><b>ç ç›¤è·¯ï¼ˆBead Plateï¼‰</b></div>
          <div class="mono small" id="statBead">â€”</div>
        </div>
        <div class="roadLegend">
          <span class="sw"><i class="p"></i>é–’</span>
          <span class="sw"><i class="b"></i>èŠ</span>
          <span class="sw"><i class="t"></i>å’Œ</span>
        </div>
        <div id="beadRoad" class="roadGrid" style="margin-top:8px;"></div>
      </div>

      <div class="roadBox">
        <div class="roadTitle">
          <div><b>å¤§è·¯ï¼ˆBig Roadï¼‰</b> <span class="muted small">ï¼ˆå’Œï¼šç–ŠåŠ  T æ¬¡æ•¸ï¼‰</span></div>
          <div class="mono small" id="statBig">â€”</div>
        </div>
        <div class="roadLegend">
          <span class="sw"><i class="p"></i>é–’</span>
          <span class="sw"><i class="b"></i>èŠ</span>
          <span class="sw"><i class="t"></i>å’Œï¼ˆç–ŠåŠ ï¼‰</span>
        </div>
        <div id="bigRoad" class="roadGrid" style="margin-top:8px;"></div>
      </div>

      <div class="roadBox">
        <div class="roadTitle">
          <div><b>å¤§çœ¼ä»”ï¼ˆBig Eye Boyï¼‰</b></div>
          <div class="mono small" id="statEye">â€”</div>
        </div>
        <div class="roadLegend">
          <span class="sw"><i class="r"></i>ç´…</span>
          <span class="sw"><i class="u"></i>è—</span>
        </div>
        <div id="eyeRoad" class="roadGrid" style="margin-top:8px;"></div>
      </div>

      <div class="roadBox">
        <div class="roadTitle">
          <div><b>å°è·¯ï¼ˆSmall Roadï¼‰</b></div>
          <div class="mono small" id="statSmall">â€”</div>
        </div>
        <div class="roadLegend">
          <span class="sw"><i class="r"></i>ç´…</span>
          <span class="sw"><i class="u"></i>è—</span>
        </div>
        <div id="smallRoad" class="roadGrid" style="margin-top:8px;"></div>
      </div>

      <div class="roadBox">
        <div class="roadTitle">
          <div><b>æ›±ç”´è·¯ï¼ˆCockroach Pigï¼‰</b></div>
          <div class="mono small" id="statCock">â€”</div>
        </div>
        <div class="roadLegend">
          <span class="sw"><i class="r"></i>ç´…</span>
          <span class="sw"><i class="u"></i>è—</span>
        </div>
        <div id="cockRoad" class="roadGrid" style="margin-top:8px;"></div>
      </div>

      <div class="roadBox">
        <div class="roadTitle">
          <div><b>å¿«é€Ÿèªªæ˜</b></div>
        </div>
        <div class="list">
- ç‰Œè·¯ç”¨ä½ æ‰‹å‹•ã€Œè¨˜éŒ„ï¼šé–’/èŠ/å’Œã€å»ºç«‹ï¼ˆæœ€ç©©ï¼Œä¸ç”¨ä½ åˆ†èŠé–’å‡ºç‰Œé †åºï¼‰
- æ‰£ç‰Œæ©Ÿç‡ç”¨ä½ ã€ŒæŒ‰éˆ•åŠ å…¥æœ¬æŠŠå·²é–‹éçš„ç‰Œã€å¾ŒæŒ‰ã€Œè¨ˆç®—ä¸‹ä¸€å±€ã€
- ç‡’ç‰Œï¼šé¸ç‡’ç‰Œé‚£å¼µ â†’ å¥—ç”¨ç‡’ç‰Œï¼ˆåªå…è¨±ä¸€æ¬¡ï¼Œé™¤éé‡åšç‡’ç‰Œ/é‡ç½®ç‰Œé´ï¼‰
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… æ‰£ç‰Œè¼¸å…¥ï¼ˆæŒ‰éˆ•ç‰ˆï¼‰ + ç‡’ç‰Œ -->
  <div class="card">
    <div class="twoCol">
      <div>
        <div class="big"><b>ğŸƒ æŒ‰éˆ•è¼¸å…¥æœ¬æŠŠå·²é–‹éçš„ç‰Œï¼ˆæ‰£ç‰Œç”¨ï¼‰</b></div>
        <div class="muted small" style="margin-top:6px;">
          ä¾‹ï¼šé–’ 2 2 è£œ 5ï¼›èŠ 3 3 è£œ 1 â†’ ä½ æŒ‰ï¼š<b>2ã€2ã€5ã€3ã€3ã€1</b>ï¼ˆé †åºä¸é‡è¦ï¼‰
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between;">
          <div><b>é»ç‰Œé¢åŠ å…¥æš«å­˜</b> <span class="muted small">ï¼ˆæ‹¬è™Ÿæ˜¯å‰©é¤˜å¼µæ•¸ï¼‰</span></div>
          <div class="row">
            <button id="btnUndoLast" class="soft">â†¶ é€€ä¸€å¼µ</button>
            <button id="btnClearBuffer" class="soft">æ¸…æš«å­˜ï¼ˆEscï¼‰</button>
          </div>
        </div>

        <div id="rankGrid" class="rankGrid" style="margin-top:10px;"></div>

        <div class="hr"></div>

        <div class="muted small">æœ¬è¼ªæš«å­˜ï¼ˆå°šæœªæ‰£é™¤ï¼‰ï¼š</div>
        <div id="bufferPills" class="row" style="margin-top:8px;"></div>
        <div id="bufferText" class="list" style="margin-top:10px;"></div>

        <div class="hr"></div>

        <div class="row" style="gap:12px;">
          <label><b>æ¨¡æ“¬æ¬¡æ•¸ï¼š</b></label>
          <input id="trials" type="number" min="1000" step="1000" value="200000" />
          <select id="preset">
            <option value="">å¿«é€Ÿé¸æ“‡</option>
            <option value="50000">50,000ï¼ˆå¿«ï¼‰</option>
            <option value="200000">200,000ï¼ˆå¹³è¡¡ï¼‰</option>
            <option value="500000">500,000ï¼ˆç©©ï¼‰</option>
            <option value="1000000">1,000,000ï¼ˆæ›´ç©©ï¼‰</option>
          </select>
          <button id="btnExport" class="soft">åŒ¯å‡ºç‹€æ…‹ JSON</button>
          <button id="btnImport" class="soft">åŒ¯å…¥ç‹€æ…‹ JSON</button>
        </div>

        <div class="hr"></div>
        <div class="big"><b>ğŸ“¦ ç‰Œé´ç‹€æ…‹</b></div>
        <div style="margin-top:8px;">å›åˆï¼š<span id="roundNo" class="pill"></span></div>
        <div style="margin-top:8px;">å‰©é¤˜å¼µæ•¸ï¼š<span id="remain" class="pill"></span></div>
        <div class="muted small" style="margin-top:8px;">æ‰£ç‰Œå¾Œå„é»æ•¸å¼µæ•¸ï¼š</div>
        <div id="shoeCounts" class="list" style="margin-top:8px;"></div>
      </div>

      <div>
        <div class="big"><b>ğŸ”¥ ç‡’ç‰Œï¼ˆBurnï¼‰</b></div>
        <div class="muted small" style="margin-top:6px;">
          è¦å‰‡ï¼šç¿»ä¸€å¼µç‡’ç‰Œï¼Œä¾é»æ•¸ç‡’æ‰åŒæ¨£å¼µæ•¸ï¼ˆå«é‚£å¼µï¼‰ã€‚<b>10/J/Q/K è¦–ç‚º 10</b>ã€‚
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnBurnToggle" class="soft">ç‡’ç‰Œï¼š<span id="burnEnabledText">é–‹</span></button>
          <button id="btnBurnReset" class="soft">é‡åšç‡’ç‰Œ</button>
        </div>

        <div class="muted small" style="margin-top:10px;">é¸ç‡’ç‰Œï¼ˆä½ çœ‹åˆ°çš„é‚£å¼µï¼‰ï¼š</div>
        <div id="burnGrid" class="rankGrid" style="margin-top:8px;"></div>

        <div class="row" style="margin-top:10px;">
          <button id="btnApplyBurn" class="primary">å¥—ç”¨ç‡’ç‰Œ</button>
        </div>

        <div id="burnStatus" class="list" style="margin-top:10px;"></div>

        <div class="hr"></div>

        <div class="big"><b>ğŸ“œ å‹ç‡ä¼°è¨ˆæ­·å²</b></div>
        <div id="history" class="list" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Sticky bottom bar -->
  <div class="sticky">
    <div class="wrap">
      <div class="left">
        <button id="btnCompute" class="primary">è¨ˆç®—ä¸‹ä¸€å±€ï¼ˆMï¼‰</button>
        <button id="btnResetShoe" class="danger">é‡ç½®ç‰Œé´ï¼ˆRï¼‰</button>
      </div>
      <div class="right">
        <span class="muted small">å¿«æ·éµï¼š<span class="k">M</span> è¨ˆç®—ï½œ<span class="k">Esc</span> æ¸…æš«å­˜ï½œ<span class="k">R</span> é‡ç½®</span>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // å¸¸æ•¸
  // =========================
  const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
  const IDX = new Map(RANKS.map((r,i)=>[r,i]));
  const MAX_DRAW = 6;
  const ROAD_ROWS = 6;

  // =========================
  // RNGï¼šWebCrypto å‡å‹»æ•´æ•¸ï¼ˆæ‹’çµ•æŠ½æ¨£é¿å…åå·®ï¼‰
  // =========================
  function randIntBelow(n){
    const max = 0x100000000; // 2^32
    const limit = max - (max % n);
    const buf = new Uint32Array(1);
    while(true){
      crypto.getRandomValues(buf);
      const x = buf[0];
      if(x < limit) return x % n;
    }
  }

  // =========================
  // ç‰Œé´ï¼ˆcountsï¼‰
  // =========================
  function newShoeCounts(nDecks=8){
    const counts = new Int16Array(RANKS.length);
    for(let i=0;i<counts.length;i++) counts[i] = 4*nDecks;
    return counts;
  }
  function shoeSize(counts){
    let s=0; for(let i=0;i<counts.length;i++) s+=counts[i]; return s;
  }
  function formatCounts(counts){
    return RANKS.map((r,i)=>`${r}:${counts[i]}`).join("  ");
  }
  function removeCardsFromShoe(counts, cards){
    for(const r of cards){
      const i = IDX.get(r);
      if(counts[i] <= 0) throw new Error(`ç‰Œé´è£¡ ${r} å·²ç¶“æ²’äº†ï¼Œä¸èƒ½å†æ‰£ã€‚`);
      counts[i]--;
    }
  }

  // å¾ counts ä¾æ¯”ä¾‹éš¨æ©ŸæŠ½ 1 å¼µï¼ˆä¸å›æ”¾ï¼‰ï¼Œå›å‚³ rank
  function drawOneFromCounts(counts){
    const total = shoeSize(counts);
    if(total <= 0) throw new Error("ç‰Œé´æ²’ç‰Œäº†ã€‚");
    const k = randIntBelow(total);
    let acc = 0;
    for(let i=0;i<counts.length;i++){
      const c = counts[i];
      if(c<=0) continue;
      if(k < acc + c){
        counts[i]--;
        return RANKS[i];
      }
      acc += c;
    }
    counts[counts.length-1]--;
    return RANKS[counts.length-1];
  }

  // =========================
  // ç™¾å®¶æ¨‚é»æ•¸ + è£œç‰Œè¦å‰‡
  // =========================
  function rankValue(rank){
    if(rank==="A") return 1;
    if(rank==="10"||rank==="J"||rank==="Q"||rank==="K") return 0;
    return Number(rank);
  }
  function handTotal(cards){
    let s=0; for(const r of cards) s += rankValue(r);
    return s % 10;
  }

  function playOneRoundFromDraw(draw6){
    const p = [draw6[0], draw6[1]];
    const b = [draw6[2], draw6[3]];
    let pt = handTotal(p);
    let bt = handTotal(b);

    // Natural
    if(pt===8||pt===9||bt===8||bt===9){
      if(pt>bt) return 0;
      if(bt>pt) return 1;
      return 2;
    }

    let idx = 4;
    let pThird = null;

    // Player draws
    if(pt <= 5){
      pThird = draw6[idx++]; p.push(pThird);
      pt = handTotal(p);
    }

    bt = handTotal(b);
    if(pThird === null){
      // Banker draws on 0-5
      if(bt <= 5){
        b.push(draw6[idx++]);
        bt = handTotal(b);
      }
    }else{
      // Banker rule depends on player's third
      const pv = rankValue(pThird);
      if(bt <= 2){
        b.push(draw6[idx++]);
      }else if(bt === 3 && pv !== 8){
        b.push(draw6[idx++]);
      }else if(bt === 4 && (pv>=2 && pv<=7)){
        b.push(draw6[idx++]);
      }else if(bt === 5 && (pv>=4 && pv<=7)){
        b.push(draw6[idx++]);
      }else if(bt === 6 && (pv===6 || pv===7)){
        b.push(draw6[idx++]);
      }
      bt = handTotal(b);
    }

    if(pt>bt) return 0;
    if(bt>pt) return 1;
    return 2;
  }

  // =========================
  // Monte Carloï¼ˆå¿«é€Ÿï¼šéƒ¨åˆ†æ´—ç‰Œ + é‚„åŸï¼‰
  // =========================
  function expandDeckFromCounts(counts){
    const deck = [];
    for(let i=0;i<counts.length;i++){
      for(let k=0;k<counts[i];k++) deck.push(RANKS[i]);
    }
    return deck;
  }
  function draw6FastInPlace(deck, swapsJ){
    const n = deck.length;
    for(let i=0;i<MAX_DRAW;i++){
      const j = i + randIntBelow(n - i);
      swapsJ[i] = j;
      const tmp = deck[i]; deck[i] = deck[j]; deck[j] = tmp;
    }
    return [deck[0],deck[1],deck[2],deck[3],deck[4],deck[5]];
  }
  function restoreDeck(deck, swapsJ){
    for(let i=MAX_DRAW-1;i>=0;i--){
      const j = swapsJ[i];
      const tmp = deck[i]; deck[i] = deck[j]; deck[j] = tmp;
    }
  }
  function estimateProbs(counts, trials, onProgress){
    const m = shoeSize(counts);
    if(m < 6) throw new Error("å‰©é¤˜ç‰Œä¸è¶³ä»¥æ¨¡æ“¬ï¼ˆè‡³å°‘è¦ >=6 å¼µï¼‰ã€‚");

    const deck = expandDeckFromCounts(counts);
    const swapsJ = new Int32Array(MAX_DRAW);

    let pw=0, bw=0, tw=0;
    const step = Math.max(5000, Math.floor(trials / 200));

    for(let k=1;k<=trials;k++){
      const draw6 = draw6FastInPlace(deck, swapsJ);
      const out = playOneRoundFromDraw(draw6);
      if(out===0) pw++;
      else if(out===1) bw++;
      else tw++;

      restoreDeck(deck, swapsJ);

      if(onProgress && (k % step === 0 || k === trials)){
        onProgress(k / trials);
      }
    }

    const total = pw+bw+tw;
    return [pw/total, bw/total, tw/total];
  }

  // =========================
  // EVï¼ˆåƒ…æ•¸å­¸å±•ç¤ºï¼‰
  // =========================
  function calcRecommendation(p, b, t){
    // å¸¸è¦‹ï¼šé–’ 1:1ï¼ŒèŠ 1:1 æŠ½ 5%ï¼Œå’Œ 8:1
    const evP = p - b;
    const evB = 0.95 * b - p;
    const evT = 8 * t - (1 - t);

    let bestSide = "é–’";
    let bestEV = evP;
    if(evB > bestEV){ bestEV = evB; bestSide = "èŠ"; }
    if(evT > bestEV){ bestEV = evT; bestSide = "å’Œ"; }

    if(bestEV < 0) bestSide = "ä¸ä¸‹";
    return { side: bestSide, evP, evB, evT, bestEV };
  }

  // =========================
  // Roadsï¼šç ç›¤ / å¤§è·¯ / ä¸‰è·¯
  // =========================
  function countResults(arr){
    let P=0,B=0,T=0;
    for(const x of arr){
      if(x==="P") P++;
      else if(x==="B") B++;
      else if(x==="T") T++;
    }
    return {P,B,T,total:arr.length};
  }

  // ç ç›¤ï¼ˆ6 è¡ŒæŒ‰åºå¡«ï¼‰
  function buildBeadGrid(arr){
    const grid = Array.from({length: ROAD_ROWS}, ()=>[]);
    for(let i=0;i<arr.length;i++){
      const col = Math.floor(i / ROAD_ROWS);
      const row = i % ROAD_ROWS;
      grid[row][col] = arr[i];
    }
    return grid;
  }

  // å¤§è·¯ï¼šç”¨ column çµæ§‹ + tie ç–ŠåŠ 
  // å›å‚³ï¼š{ cols, lastPos, placements }ï¼›cols[col][row] = {side,ties}
  function buildBigRoad(arr){
    const cols = [];
    let curSide = null;
    let c = 0, r = 0;

    // occupancy: Map "c,r" => true
    const occ = new Set();

    // è¨˜æ¯æ¬¡ã€Œéå’Œã€è½é»ï¼ˆçµ¦ä¸‰è·¯åˆ¤æ–·ç”¨ï¼‰
    // placements.push({c,r})
    const placements = [];

    function key(cc, rr){ return cc + "," + rr; }
    function has(cc, rr){ return occ.has(key(cc,rr)); }
    function ensureCell(cc, rr, side){
      if(!cols[cc]) cols[cc] = [];
      if(!cols[cc][rr]) cols[cc][rr] = {side, ties:0};
      else cols[cc][rr].side = side;
      occ.add(key(cc,rr));
    }
    function addTieToLast(){
      if(curSide === null) return;
      ensureCell(c,r,curSide);
      cols[c][r].ties += 1;
    }

    for(const x of arr){
      if(x === "T"){ addTieToLast(); continue; }

      if(curSide === null){
        curSide = x;
        c = 0; r = 0;
        ensureCell(c,r,curSide);
        placements.push({c,r});
        continue;
      }

      if(x === curSide){
        // åŒè‰²ï¼šå¾€ä¸‹ï¼›è‹¥åˆ°åº•æˆ–è¢«å ï¼Œå¾€å³ä¸¦åœåœ¨åŸ row
        const nr = r + 1;
        if(nr >= ROAD_ROWS || has(c, nr)){
          c += 1;
          // r ä¸è®Š
        }else{
          r = nr;
        }
        ensureCell(c,r,curSide);
        placements.push({c,r});
      }else{
        // è®Šè‰²ï¼šæ–°æ¬„å›é ‚
        curSide = x;
        c += 1;
        r = 0;
        ensureCell(c,r,curSide);
        placements.push({c,r});
      }
    }

    return { cols, placements };
  }

  // å¤§è·¯æ¸²æŸ“ï¼šcolumn-majorï¼ˆgrid-auto-flow: columnï¼‰
  function renderRoadGrid(el, cols, mode){
    el.innerHTML = "";
    const maxCol = Math.max(1, cols.length);

    for(let col=0; col<maxCol; col++){
      for(let row=0; row<ROAD_ROWS; row++){
        const cell = document.createElement("div");
        cell.className = "cell";

        const v = (cols[col] ? cols[col][row] : null);
        if(v){
          const dot = document.createElement("div");
          dot.className = "dot " + v.side; // P/B OR R/U
          cell.appendChild(dot);

          if(mode === "big" && v.ties > 0){
            const badge = document.createElement("div");
            badge.className = "tieBadge";
            badge.textContent = "T" + v.ties;
            cell.appendChild(badge);
          }
        }
        el.appendChild(cell);
      }
    }
  }

  // ä¸‰è·¯åˆ¤æ–·ï¼ˆBig Eye / Small / Cockroachï¼‰
  // offset: 1 / 2 / 3
  // è¦å‰‡ï¼š
  // - è‹¥è½é» row>0ï¼šçœ‹ã€Œå·¦ offset æ¬„ã€åŒä¸€ row æ˜¯å¦å­˜åœ¨ â†’ æœ‰=ç´…ï¼Œç„¡=è—
  // - è‹¥è½é» row==0ï¼ˆé–‹æ–°æ¬„ï¼‰ï¼šæ¯”ã€Œå‰ä¸€æ¬„é«˜åº¦ã€èˆ‡ã€Œå‰ä¸€æ¬„å¾€å·¦ offset æ¬„é«˜åº¦ã€æ˜¯å¦ç›¸ç­‰ â†’ ç›¸ç­‰=ç´…ï¼Œä¸ç­‰=è—
  // ä¸è¶³è³‡æ–™æ™‚ï¼ˆå·¦é‚Šä¸å¤ æ¬„ï¼‰â†’ ä¸ç”¢ç”Ÿè¨˜è™Ÿ
  function buildDerivedMarksFromBigRoad(bigCols, placements, offset){
    const marks = []; // "R" or "U"
    function colHeight(ci){
      const col = bigCols[ci] || [];
      let h = 0;
      for(let i=0;i<ROAD_ROWS;i++){
        if(col[i]) h = i+1;
      }
      return h; // 0..6
    }
    function exists(ci, ri){
      return !!(bigCols[ci] && bigCols[ci][ri]);
    }

    for(const pos of placements){
      const c = pos.c, r = pos.r;

      // ä¸‰è·¯éƒ½æœ‰ã€Œèµ·ç®—æ¬„ä½ã€é™åˆ¶ï¼šoffset å°æ‡‰éœ€è¦è‡³å°‘ c >= offset+1 æ‰èƒ½åˆ¤æ–·ï¼ˆå¯¦å‹™ä¸Šæ•ˆæœä¸€è‡´ï¼‰
      // é€™è£¡ç”¨é‚è¼¯æª¢æŸ¥å³å¯ï¼š
      if(r === 0){
        const a = c - 1;
        const b = c - 1 - offset;
        if(b < 0) continue;
        const h1 = colHeight(a);
        const h2 = colHeight(b);
        marks.push(h1 === h2 ? "R" : "U");
      }else{
        const left = c - offset;
        if(left < 0) continue;
        marks.push(exists(left, r) ? "R" : "U");
      }
    }
    return marks;
  }

  // å°‡ marksï¼ˆR/U åºåˆ—ï¼‰ç”¨ã€Œå¤§è·¯è½é»è¦å‰‡ã€ç”Ÿæˆ gridï¼ˆä½†åªæœ‰é¡è‰²ï¼Œä¸å« tieï¼‰
  function buildColorBigRoadFromMarks(marks){
    const cols = [];
    let cur = null;
    let c=0, r=0;
    const occ = new Set();
    function key(cc, rr){ return cc + "," + rr; }
    function has(cc, rr){ return occ.has(key(cc,rr)); }
    function ensure(cc, rr, side){
      if(!cols[cc]) cols[cc] = [];
      if(!cols[cc][rr]) cols[cc][rr] = {side, ties:0};
      else cols[cc][rr].side = side;
      occ.add(key(cc,rr));
    }

    for(const x of marks){
      if(cur === null){
        cur = x; c=0; r=0; ensure(c,r,cur); continue;
      }
      if(x === cur){
        const nr = r + 1;
        if(nr >= ROAD_ROWS || has(c, nr)){
          c += 1;
        }else{
          r = nr;
        }
        ensure(c,r,cur);
      }else{
        cur = x;
        c += 1;
        r = 0;
        ensure(c,r,cur);
      }
    }
    return cols;
  }

  // =========================
  // Burn
  // =========================
  function burnCountFromCard(rank){
    if(rank === "A") return 1;
    if(rank === "10" || rank === "J" || rank === "Q" || rank === "K") return 10;
    return Number(rank); // 2..9
  }

  // =========================
  // UI elements
  // =========================
  const elMsg = document.getElementById("msg");
  const elBar = document.getElementById("bar");

  const elP = document.getElementById("pProb");
  const elB = document.getElementById("bProb");
  const elT = document.getElementById("tProb");
  const elRec = document.getElementById("rec");
  const elRec2 = document.getElementById("rec2");

  const elRankGrid = document.getElementById("rankGrid");
  const elBurnGrid = document.getElementById("burnGrid");

  const elBufferPills = document.getElementById("bufferPills");
  const elBufferText = document.getElementById("bufferText");

  const elTrials = document.getElementById("trials");
  const elPreset = document.getElementById("preset");

  const elRound = document.getElementById("roundNo");
  const elRemain = document.getElementById("remain");
  const elCounts = document.getElementById("shoeCounts");

  const elBurnEnabledText = document.getElementById("burnEnabledText");
  const elBurnStatus = document.getElementById("burnStatus");

  const elHist = document.getElementById("history");

  // Roads UI
  const elResMsg = document.getElementById("resMsg");
  const elBeadRoad = document.getElementById("beadRoad");
  const elBigRoad = document.getElementById("bigRoad");
  const elEyeRoad = document.getElementById("eyeRoad");
  const elSmallRoad = document.getElementById("smallRoad");
  const elCockRoad = document.getElementById("cockRoad");

  const elStatBead = document.getElementById("statBead");
  const elStatBig = document.getElementById("statBig");
  const elStatEye = document.getElementById("statEye");
  const elStatSmall = document.getElementById("statSmall");
  const elStatCock = document.getElementById("statCock");

  function setMsg(text, kind="muted"){
    elMsg.className = kind + " small";
    elMsg.textContent = text;
  }
  function setResMsg(text, kind="muted"){
    elResMsg.className = kind + " small";
    elResMsg.textContent = text;
  }
  function resetProgress(){ elBar.style.width = "0%"; }
  function setProgress(frac){ elBar.style.width = `${Math.max(0,Math.min(1,frac))*100}%`; }
  function pct(x){ return (x*100).toFixed(4) + "%"; }

  // =========================
  // State
  // =========================
  let shoe = newShoeCounts(8);
  let buffer = [];
  let roundNo = 1;
  let history = [];

  // burn
  let burnEnabled = true;
  let burnApplied = false;
  let burnCard = null;
  let burnTotal = 0;

  // road results: "P" / "B" / "T"
  let results = [];

  // =========================
  // localStorage
  // =========================
  const SAVE_KEY = "baccarat_mc_pro_final_v1";

  function saveState(){
    try{
      const obj = {
        shoe: Array.from(shoe),
        buffer: buffer.slice(),
        roundNo,
        history: history.slice(),
        trials: Number(elTrials.value) || 200000,

        burnEnabled, burnApplied, burnCard, burnTotal,

        results: results.slice(),

        pProb: elP.textContent,
        bProb: elB.textContent,
        tProb: elT.textContent,
        rec: elRec.textContent,
        rec2: elRec2.textContent,
      };
      localStorage.setItem(SAVE_KEY, JSON.stringify(obj));
    }catch(_e){}
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(SAVE_KEY);
      if(!raw) return false;
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.shoe) || obj.shoe.length !== RANKS.length) return false;

      shoe = new Int16Array(obj.shoe.map(Number));
      buffer = Array.isArray(obj.buffer) ? obj.buffer.map(String) : [];
      roundNo = Number(obj.roundNo || 1);
      history = Array.isArray(obj.history) ? obj.history : [];
      if(obj.trials) elTrials.value = String(obj.trials);

      burnEnabled = !!obj.burnEnabled;
      burnApplied = !!obj.burnApplied;
      burnCard = obj.burnCard || null;
      burnTotal = Number(obj.burnTotal || 0);

      results = Array.isArray(obj.results) ? obj.results.filter(x=>x==="P"||x==="B"||x==="T") : [];

      if(obj.pProb) elP.textContent = obj.pProb;
      if(obj.bProb