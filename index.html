<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç™¾å®¶æ¨‚ PROï½œæŒ‰éˆ•è¼¸å…¥æ‰£ç‰Œï½œ8å‰¯ç‰Œè’™åœ°å¡ç¾…</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#ffffff12;
      --line:#ffffff22;
      --P:#1976d2;     /* é–’ï¼šè— */
      --B:#d32f2f;     /* èŠï¼šç´… */
      --T:#2e7d32;     /* å’Œï¼šç¶  */
      --text:#eaf0ff;
      --muted:#b7c3e6;
      --radius:18px;
      --radius2:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow2: 0 8px 18px rgba(0,0,0,.28);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% -20%, #2b3cff55, transparent 60%),
                  radial-gradient(900px 500px at 10% 20%, #00d1ff20, transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, #ff3b3020, transparent 60%),
                  var(--bg);
      color:var(--text);
      padding: 18px 14px 24px;
    }
    .app{max-width:1100px;margin:0 auto;}
    .topbar{
      display:grid; grid-template-columns: 1fr auto 1fr;
      gap:10px; border-radius:28px; overflow:hidden;
      box-shadow:var(--shadow); border:1px solid var(--line);
    }
    .side{display:flex;align-items:center;padding:16px;min-height:76px;}
    .side.player{background:linear-gradient(90deg,#0e5fe0,var(--P));}
    .side.banker{background:linear-gradient(90deg,var(--B),#b71c1c);justify-content:flex-end;}
    .label{display:flex;flex-direction:column;gap:2px;font-weight:1000;letter-spacing:.6px;line-height:1.05;}
    .label .zh{font-size:40px;text-shadow:0 2px 0 rgba(0,0,0,.25);}
    .label .en{font-size:18px;opacity:.95;}
    .score{
      display:flex;align-items:center;justify-content:center;
      padding:10px 12px;background:#0000002b;
      border-left:1px solid #ffffff1c;border-right:1px solid #ffffff1c;
      min-width:180px;
    }
    .score .digit{font-size:64px;font-weight:1100;padding:0 12px;line-height:1;color:#fff;text-shadow:0 3px 0 rgba(0,0,0,.25);}

    .grid2{margin-top:12px;display:grid;grid-template-columns: 520px 1fr;gap:12px;}
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr;} .score{min-width:160px;} }

    .panel{
      background: linear-gradient(180deg, #ffffff10, #00000010);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      min-width:0;
    }
    h1{margin:0 0 8px;font-size:1.25rem;}
    .muted{color:var(--muted);}
    .hr{height:1px;background:#ffffff14;margin:10px 0;}

    /* ---- input pad ---- */
    .pad{display:grid;grid-template-columns: repeat(7, 1fr);gap:8px;margin-top:10px;}
    .btn{
      appearance:none;border:none;
      background:#ffffff14;border:1px solid #ffffff20;color:var(--text);
      padding:10px 8px;border-radius:14px;
      font-weight:1000;cursor:pointer;user-select:none;
    }
    .btn:hover{background:#ffffff1a;}
    .btn:active{transform:scale(.99);}
    .btn.primary{background:#1b5cff55;border-color:#1b5cff88;}
    .btn.danger{background:#ff3b3050;border-color:#ff3b3077;}
    .btn.ok{background:#2e7d3250;border-color:#2e7d3277;}
    .btn.small{padding:8px 8px;font-size:13px;font-weight:900;}

    .pills{margin-top:8px; display:flex; flex-wrap:wrap; max-width:100%; gap:6px; overflow:hidden;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;background:#0000001a;border:1px solid #ffffff20;
      border-radius:999px;font-weight:1000;margin:0;
      max-width:100%;
      flex:0 1 auto;
    }
    .pill .x{opacity:.85;cursor:pointer;border:1px solid #ffffff22;border-radius:999px;padding:0 8px;}
    .pill .x:active{transform:scale(.98);}

    /* ---- probs ---- */
    .probRow{display:grid;grid-template-columns: 1fr 1fr 1fr;gap:10px;margin-top:10px;}
    .prob{
      border:1px solid #ffffff20;background:#0000001a;border-radius:16px;
      padding:10px;min-height:110px;display:flex;flex-direction:column;justify-content:space-between;
      min-width:0;
    }
    .prob .k{font-weight:1100;letter-spacing:.5px;}
    .prob .v{font-size:30px;font-weight:1100;}
    .prob.P .k,.prob.P .v{color:#9ac8ff;}
    .prob.B .k,.prob.B .v{color:#ffb2b2;}
    .prob.T .k,.prob.T .v{color:#aef2c9;}

    .ev{
      margin-top:10px;border:1px solid #ffffff20;background:#0000001a;border-radius:16px;padding:10px;
    }
    .rowline{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .rowline > *{min-width:0;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; overflow-wrap:anywhere; word-break:break-word;}
    select,input[type="number"]{
      background:#0000002a;border:1px solid #ffffff20;color:var(--text);
      border-radius:12px;padding:10px 10px;font-weight:900;outline:none;
    }
    .hint{color:var(--muted);font-size:13px;line-height:1.35;opacity:.9;margin-top:8px;}

    /* ğŸ”’ é˜²æ­¢ç•«é¢å·¦å³è®Šå¯¬ */
    html, body { width:100%; max-width:100%; overflow-x:hidden; }
    .grid2 { min-width:0; }

    @media (max-width: 480px){
      .pad { grid-template-columns: repeat(4, 1fr); }
      #btnCalc { grid-column: span 4; }
    }

    .miniRow{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      justify-content:flex-start;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid #ffffff20; background:#00000022;
      font-weight:900;
    }
    .rangeWrap{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    input[type="range"]{ width: 160px; }
  </style>
</head>

<body>
<div class="app">

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="side player">
      <div class="label"><div class="zh">é–’</div><div class="en">PLAYER</div></div>
    </div>
    <div class="score" aria-label="Score">
      <div id="scoreP" class="digit">â€“</div>
      <div id="scoreB" class="digit">â€“</div>
    </div>
    <div class="side banker">
      <div class="label"><div class="zh">èŠ</div><div class="en">BANKER</div></div>
    </div>
  </div>

  <div class="grid2">

    <!-- LEFT: INPUT -->
    <div class="panel">
      <h1>â‘  æŒ‰éˆ•è¼¸å…¥å·²é–‹éçš„ç‰Œï¼ˆæ‰£ç‰Œï¼‰</h1>
      <div class="muted">åªéœ€è¦è¼¸å…¥ç‰Œé»å³å¯ï¼ˆèŠ±è‰²ä¸å½±éŸ¿ç™¾å®¶æ¨‚é»æ•¸/è£œç‰Œè¦å‰‡ï¼‰ã€‚10/J/Q/K éƒ½ç®— 0 é»ã€‚</div>

      <div class="hr"></div>

      <div class="rowline">
        <div>
          <div class="muted">é‹ç‹€æ…‹</div>
          <div id="shoeInfo" class="mono">â€”</div>
        </div>
        <div class="rowline" style="gap:8px;">
          <button class="btn danger" id="btnNewShoe">æ–°é‹ï¼ˆé‡ç½®ï¼‰</button>
          <button class="btn" id="btnUndo">Undo</button>
          <button class="btn" id="btnClear">æ¸…ç©ºå·²è¼¸å…¥</button>
        </div>
      </div>

      <div class="pad" aria-label="Card input">
        <button class="btn" data-r="A">A</button>
        <button class="btn" data-r="2">2</button>
        <button class="btn" data-r="3">3</button>
        <button class="btn" data-r="4">4</button>
        <button class="btn" data-r="5">5</button>
        <button class="btn" data-r="6">6</button>
        <button class="btn" data-r="7">7</button>
        <button class="btn" data-r="8">8</button>
        <button class="btn" data-r="9">9</button>
        <button class="btn" data-r="10">10</button>
        <button class="btn" data-r="J">J</button>
        <button class="btn" data-r="Q">Q</button>
        <button class="btn" data-r="K">K</button>

        <button class="btn ok" id="btnCalc">è¨ˆç®—ä¸‹ä¸€å±€æ©Ÿç‡</button>
      </div>

      <div class="pills" id="pills"></div>

      <div class="hr"></div>

      <div class="rowline">
        <div>
          <div class="muted">è’™åœ°å¡ç¾…æ¬¡æ•¸</div>
          <div class="rowline" style="justify-content:flex-start;">
            <input id="trials" type="number" min="5000" step="5000" value="50000">
            <span class="muted">ï¼ˆæ‰‹æ©Ÿå»ºè­° 20,000~80,000ï¼‰</span>
          </div>
        </div>
      </div>

      <div class="hint">
        æé†’ï¼šæ‰£ç‰Œè¶Šå¤šï¼Œæ©Ÿç‡æœƒè·Ÿã€Œç†è«–å¸¸æ…‹ã€ç•¥å¾®åç§»ï¼›ä½†é€šå¸¸åç§»å¾ˆå°ã€‚<br>
        ä¸‹é¢ã€Œå¯¦æˆ°æ´¾ç‰Œè·¯ä¿®æ­£ã€æ˜¯ç¶“é©—æ¬Šé‡ï¼šä½ å¯ä»¥èª¿å°ã€èª¿å¤§ã€æˆ–é—œé–‰ã€‚
      </div>
    </div>

    <!-- RIGHT: OUTPUT -->
    <div class="panel">
      <h1>â‘¢ ä¸‹ä¸€å±€ï¼šèŠ / é–’ / å’Œ æ©Ÿç‡ï¼ˆ8å‰¯ç‰Œï½œæ‰£ç‰Œå¾Œï½œMCï¼‰</h1>

      <div class="probRow">
        <div class="prob B">
          <div class="k">èŠ å‹ç‡</div>
          <div class="v" id="pB">â€”</div>
          <div class="muted mono" id="pB2">â€”</div>
          <div class="muted mono" id="pB_adj">ä¿®æ­£å¾Œï¼šâ€”</div>
        </div>
        <div class="prob P">
          <div class="k">é–’ å‹ç‡</div>
          <div class="v" id="pP">â€”</div>
          <div class="muted mono" id="pP2">â€”</div>
          <div class="muted mono" id="pP_adj">ä¿®æ­£å¾Œï¼šâ€”</div>
        </div>
        <div class="prob T">
          <div class="k">å’Œ å‹ç‡</div>
          <div class="v" id="pT">â€”</div>
          <div class="muted mono" id="pT2">â€”</div>
          <div class="muted mono" id="pT_adj">ä¿®æ­£å¾Œï¼šâ€”</div>
        </div>
      </div>

      <div class="ev">
        <div class="rowline">
          <div style="font-weight:1100;">ä¸‹æ³¨å»ºè­°ï¼ˆæ¿€é€²æ¨¡å¼ï¼‰</div>
          <div class="rowline" style="gap:8px;">
            <span class="muted">èŠæŠ½æ°´</span>
            <select id="commission">
              <option value="0.05" selected>5%ï¼ˆå¸¸è¦‹ï¼‰</option>
              <option value="0.00">0%ï¼ˆå…æ°´ï¼‰</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="rowline" style="gap:8px;">
          <span class="muted">ç­–ç•¥</span>
          <select id="strategy">
            <option value="evmax" selected>EV æœ€å¤§ï¼ˆåæ¿€é€²ï¼šæ°¸é ä¸‹æ³¨ï¼‰</option>
            <option value="negok">å®¹å¿è² EVä¹Ÿä¸‹æ³¨ï¼ˆæ›´æ¿€é€²ï¼‰</option>
            <option value="follow">è¿½è·¯ï¼ˆé€£èŠ/é€£é–’å°±è·Ÿï¼‰</option>
            <option value="fade">åå‘ï¼ˆé€£èŠ/é€£é–’å°±åè²·ï¼‰</option>
            <option value="martingale">é¦¬ä¸å€å£“ï¼ˆè¼¸å°±å€å£“ï¼Œä¸Šé™å°é ‚ï¼‰</option>
          </select>

          <span class="muted">è² EVå®¹å¿</span>
          <input id="negTol" type="number" step="0.001" value="-0.010" style="width:110px;">
          <span class="muted mono">(ä¾‹ -0.010)</span>
        </div>

        <div class="rowline" style="gap:8px;margin-top:8px;">
          <span class="muted">è¿½è·¯/åå‘ éœ€è¦é€£çºŒ</span>
          <input id="streakN" type="number" min="2" step="1" value="2" style="width:80px;">
          <span class="muted">æ¬¡æ‰è§¸ç™¼</span>

          <span class="muted">é¦¬ä¸ä¸Šé™</span>
          <input id="martCap" type="number" min="2" step="1" value="8" style="width:80px;">
          <span class="muted">å–®ä½</span>
        </div>

        <div class="hr"></div>

        <!-- âœ… å¯¦æˆ°æ´¾ï¼šç‰Œè·¯ä¿®æ­£ -->
        <div class="rowline">
          <div style="font-weight:1100;">å¯¦æˆ°æ´¾ï¼šç‰Œè·¯ä¿®æ­£ï¼ˆå¯èª¿ï¼‰</div>
          <div class="miniRow">
            <label class="chip">
              <input id="roadOn" type="checkbox" checked>
              å•Ÿç”¨ä¿®æ­£
            </label>
            <label class="chip">
              æœ€è¿‘ <input id="roadWin" type="number" min="6" max="60" step="2" value="18" style="width:80px;">
              æ‰‹
            </label>
          </div>
        </div>

        <div class="hr"></div>

        <div class="miniRow">
          <div class="rangeWrap">
            <span class="muted">é€£èŠ/é€£é–’ï¼ˆé †å‹¢ï¼‰</span>
            <input id="wTrend" type="range" min="0" max="30" value="10">
            <span class="mono" id="wTrendV">0.010</span>
          </div>
          <div class="rangeWrap">
            <span class="muted">æ–¬é¾/è·³ï¼ˆé€†å‹¢ï¼‰</span>
            <input id="wChop" type="range" min="0" max="30" value="8">
            <span class="mono" id="wChopV">0.008</span>
          </div>
          <div class="rangeWrap">
            <span class="muted">å’Œå±€åé«˜</span>
            <input id="wTie" type="range" min="0" max="30" value="6">
            <span class="mono" id="wTieV">0.006</span>
          </div>
        </div>

        <div class="hint">
          èªªæ˜ï¼š<br>
          1) ä½ ç”¨ä¸‹é¢ã€Œè¨˜éŒ„ä¸Šä¸€å±€çµæœã€å»é¤µç‰Œè·¯ï¼ˆèŠ/é–’/å’Œï¼‰ã€‚<br>
          2) ä¿®æ­£å¹…åº¦æ˜¯ã€Œå¾®èª¿ã€ï¼šé è¨­æ¯å€‹æ¬Šé‡æœ€å¤§ç´„ 3% å…§çš„æ‹‰å‹•ï¼ˆå¯è‡ªè¡Œèª¿å¤§/èª¿å°ï¼‰ã€‚<br>
          3) è‹¥ä½ åªæƒ³çœ‹ç´”æ‰£ç‰Œ MCï¼Œå°±æŠŠã€Œå•Ÿç”¨ä¿®æ­£ã€é—œæ‰ã€‚
        </div>

        <div class="hr"></div>

        <div class="mono" id="evLine">â€”</div>
        <div class="mono" id="betLine" style="margin-top:6px;">â€”</div>
      </div>

      <div class="hr"></div>

     <div class="rowline" style="justify-content:space-between; gap:10px;">
  <div>
    <div class="muted">ä¸Šå±€å‹å®¶</div>
    <div class="mono" id="lastWinner">â€”</div>
    <div class="muted mono" id="lastStreak">â€”</div>
  </div>
<div class="hr"></div>

<div class="rowline" style="justify-content:flex-start; gap:10px; align-items:center;">
  <div>
    <div class="muted">è¿‘ N æŠŠå¯¦éš›å‘½ä¸­ç‡å›æ¸¬</div>
    <div class="muted" style="font-size:12px; opacity:.9;">ä¾ã€Œä½ ç•¶æ™‚ç•«é¢å»ºè­°ã€vsã€Œä½ é»çš„çµæœã€è¨ˆç®—</div>
  </div>

  <div class="rowline" style="gap:8px; justify-content:flex-start;">
    <span class="muted">N</span>
    <input id="backN" type="number" min="5" step="5" value="30" style="width:90px;">
  </div>
</div>

<div class="mono" id="backLine" style="margin-top:8px;">â€”</div>
  <div class="rowline" style="justify-content:flex-start; gap:8px;">
    <span class="muted">é»ä¸€ä¸‹å°±è¨˜éŒ„ï¼ˆæœƒå½±éŸ¿ç‰Œè·¯/è¿½è·¯/å€å£“ï¼‰</span>
    <button class="btn small" id="recB">èŠ</button>
    <button class="btn small" id="recP">é–’</button>
    <button class="btn small" id="recT">å’Œ</button>
    <button class="btn small danger" id="recClear">æ¸…ç©º</button>
  </div>
</div>

      <div class="hint">
        âš ï¸ æ¿€é€²ç­–ç•¥æœƒè®“æ³¢å‹•è®Šå¾ˆå¤§ï¼ˆå°¤å…¶é¦¬ä¸/è¿½è·¯ï¼‰ã€‚æˆ‘ç”¨ã€Œå–®ä½ã€è¡¨ç¤ºï¼Œä¸å»ºè­°ç”¨çœŸé‡‘é¡ç¡¬è¿½ã€‚
      </div>

      <div class="hr"></div>
      <div class="muted">æœ€å¾Œä¸€æ¬¡è¨ˆç®—è€—æ™‚ï¼š<span class="mono" id="ms">â€”</span></div>
    </div>

  </div>
</div>

<script>
//===========================
// ====== æ¿€é€²ç­–ç•¥ç‹€æ…‹ ======
const betState = {
  history: [],
  lastPick: null,
  unit: 1,
  logs: [] // âœ… å›æ¸¬ï¼šæ¯æŠŠ {pick, result, unit, net}
};
// âœ… è¨˜ä½ã€Œä¸Šæ¬¡è¨ˆç®—å‡ºçš„å‹ç‡ã€ï¼ˆç”¨ä¾†æŒ‰ä¸Šå±€å‹å®¶å¾Œå³æ™‚æ›´æ–°å»ºè­°ï¼Œä¸ç”¨é‡è·‘MCï¼‰
let lastCalc = {
  has: false,
  pP: 0, pB: 0, pT: 0,      // åŸå§‹MC
  aP: 0, aB: 0, aT: 0       // ä¿®æ­£å¾Œ
};

function lastNonTieStreak(hist){
  let i = hist.length - 1;
  while (i >= 0 && hist[i] === 'T') i--;
  if (i < 0) return {side:null, len:0};
  const side = hist[i];
  let len = 0;
  while (i >= 0){
    if (hist[i] === 'T') { i--; continue; }
    if (hist[i] !== side) break;
    len++; i--;
  }
  return {side, len};
}

function opposite(side){
  if (side === 'B') return 'P';
  if (side === 'P') return 'B';
  return 'T';
}

function sideName(s){
  return s==='B' ? 'èŠ' : s==='P' ? 'é–’' : 'å’Œ';
}

function setText(id, txt){
  const el = document.getElementById(id);
  if (el) el.textContent = txt;
}

function fmtPct(x){ return (x*100).toFixed(3) + '%'; }

function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

function calcEV(pP, pB, pT, commission){
  const evP = 2*pP - 1;
  const evB = pB*(1-commission) - (1-pB);
  const evT = 9*pT - 1; // 1:8 tie
  return {evP, evB, evT};
}

//===========================
// âœ… å¯¦æˆ°æ´¾ï¼šç‰Œè·¯ä¿®æ­£ï¼ˆæ¬Šé‡æ¨¡å‹ï¼‰
function getRoadParams(){
  const on = !!document.getElementById('roadOn')?.checked;
  const win = Math.max(6, Math.min(60, parseInt(document.getElementById('roadWin')?.value,10) || 18));
  // range 0..30 â†’ 0..0.030
  const wTrend = (parseInt(document.getElementById('wTrend')?.value,10) || 0) / 1000;
  const wChop  = (parseInt(document.getElementById('wChop')?.value,10) || 0) / 1000;
  const wTie   = (parseInt(document.getElementById('wTie')?.value,10) || 0) / 1000;
  return {on, win, wTrend, wChop, wTie};
}

function updateRoadParamLabels(){
  const p = getRoadParams();
  setText('wTrendV', p.wTrend.toFixed(3));
  setText('wChopV',  p.wChop.toFixed(3));
  setText('wTieV',   p.wTie.toFixed(3));
}

// å–å¾—æœ€è¿‘ç‰Œè·¯ç‰¹å¾µï¼ˆåªçœ‹æœ€å¾Œ win æ‰‹ï¼‰
function roadFeatures(hist, win){
  const recent = hist.slice(-win);
  const nonTie = recent.filter(x=>x!=='T');
  const last = nonTie.length ? nonTie[nonTie.length-1] : null;

  // streak
  let streakSide = null, streakLen = 0;
  if (nonTie.length){
    streakSide = nonTie[nonTie.length-1];
    for (let i=nonTie.length-1;i>=0;i--){
      if (nonTie[i] === streakSide) streakLen++;
      else break;
    }
  }

  // chop rateï¼ˆäº¤æ›¿ç‡ï¼‰ï¼šç›¸é„°æ˜¯å¦ä¸åŒ
  let switches=0, pairs=0;
  for (let i=1;i<nonTie.length;i++){
    pairs++;
    if (nonTie[i] !== nonTie[i-1]) switches++;
  }
  const chopRate = pairs ? switches/pairs : 0;

  // tie rate
  const tieRate = recent.length ? recent.filter(x=>'T'===x).length / recent.length : 0;

  return {recent, nonTie, last, streakSide, streakLen, chopRate, tieRate};
}

// å¯¦æˆ°æ´¾ä¿®æ­£ï¼šå¾®èª¿ pB/pP/pT ä¸¦é‡æ­£è¦åŒ–
function applyRoadAdjust(pP, pB, pT, hist){
  const p = getRoadParams();
  if (!p.on) return {pP, pB, pT, note:'ä¿®æ­£é—œé–‰'};

  const f = roadFeatures(hist, p.win);

  // åŸºæº–å’Œå±€ç‡å¤§ç´„ ~0.095ï¼ˆ8å‰¯ç‰Œç†è«–ï¼‰ï¼Œåšã€Œåé«˜ã€æ‰æ¨
  const baseTie = 0.095;

  let dB = 0, dP = 0, dT = 0;
  let notes = [];

  // 1) é †å‹¢ï¼šé€£èŠ/é€£é–’è¶Šé•·ï¼Œå°å¹…æ¨åŒé‚Š
  if (f.streakSide && f.streakLen >= 2){
    const k = clamp((f.streakLen - 1) / 6, 0, 1); // 2~7æ‰‹é€æ­¥é£½å’Œ
    const push = p.wTrend * k; // 0..wTrend
    if (f.streakSide === 'B'){ dB += push; dP -= push; notes.push(`é †å‹¢+${push.toFixed(3)}(èŠé€£${f.streakLen})`); }
    if (f.streakSide === 'P'){ dP += push; dB -= push; notes.push(`é †å‹¢+${push.toFixed(3)}(é–’é€£${f.streakLen})`); }
  }

  // 2) æ–¬é¾/è·³ï¼šè‹¥ chopRate é«˜ï¼ˆå¸¸æ›é‚Šï¼‰ï¼Œæ¨ã€Œåå‘ã€ä¸€é»é»
  if (f.last && f.nonTie.length >= 6){
    const k = clamp((f.chopRate - 0.55) / 0.35, 0, 1); // >0.55 æ‰é–‹å§‹åè·³
    const push = p.wChop * k;
    if (push > 0){
      const opp = opposite(f.last);
      if (opp === 'B'){ dB += push; dP -= push; notes.push(`è·³è·¯+${push.toFixed(3)}(ååè²·)`); }
      if (opp === 'P'){ dP += push; dB -= push; notes.push(`è·³è·¯+${push.toFixed(3)}(ååè²·)`); }
    }
  }

  // 3) å’Œå±€åé«˜ï¼šæœ€è¿‘ tieRate é«˜æ–¼ baseTie â†’ å°å¹…æ¨å’Œ
  if (f.recent.length >= 10){
    const k = clamp((f.tieRate - baseTie) / 0.08, 0, 1); // é«˜åˆ° +8% æ™‚é£½å’Œ
    const push = p.wTie * k;
    if (push > 0){
      dT += push;
      // å’Œæ¨ä¸Šå»ï¼Œå¾ B/P å¹³å‡æ‰£å›
      dB -= push/2;
      dP -= push/2;
      notes.push(`å’Œåé«˜+${push.toFixed(3)}(tie ${Math.round(f.tieRate*100)}%)`);
    }
  }
function applyLastWinnerBias(pP, pB, pT){
  const streak = lastNonTieStreak(betState.history);
  let aP = pP, aB = pB, aT = pT;

  if (!streak.side || streak.len < 2){
    return { aP, aB, aT };
  }

  const step = 0.0015;               // 0.15%
  const cap = 0.006;                 // ä¸Šé™ 0.6%
  const bias = Math.min(streak.len * step, cap);

  if (streak.side === 'B'){
    aB += bias;
    aP -= bias;
  } else if (streak.side === 'P'){
    aP += bias;
    aB -= bias;
  }

  // ä¿è­·ï¼šä¸è®“ä»»ä½•å€¼ < 0
  aP = Math.max(0, aP);
  aB = Math.max(0, aB);

  return { aP, aB, aT };
}
  // å¥—ç”¨
  let aB = pB + dB;
  let aP = pP + dP;
  let aT = pT + dT;

  // é˜²çˆ†ï¼šå…ˆä¸‹é™ï¼Œå†é‡æ­£è¦åŒ–
  aB = clamp(aB, 0.001, 0.999);
  aP = clamp(aP, 0.001, 0.999);
  aT = clamp(aT, 0.001, 0.999);

  const s = aB + aP + aT;
  aB /= s; aP /= s; aT /= s;

  // æœ€å¾Œå†ä¿è­·ä¸€æ¬¡
  const s2 = aB + aP + aT;
  aB /= s2; aP /= s2; aT /= s2;

  const note = notes.length ? notes.join('ï½œ') : 'ç„¡é¡¯è‘—ç‰Œè·¯è¨Šè™Ÿ';
  return {pP:aP, pB:aB, pT:aT, note};
}

//===========================
// ä¸‹æ³¨ç­–ç•¥
function pickByStrategy(pP, pB, pT){
  const commission = parseFloat(document.getElementById('commission').value || '0.05');
  const strategy = document.getElementById('strategy').value;
  const negTol = parseFloat(document.getElementById('negTol').value || '-0.010');
  const streakN = Math.max(2, parseInt(document.getElementById('streakN').value,10) || 2);

  const {evP, evB, evT} = calcEV(pP, pB, pT, commission);

  const evList = [
    {side:'P', ev:evP},
    {side:'B', ev:evB},
    {side:'T', ev:evT},
  ].sort((a,b)=>b.ev-a.ev);
  const best = evList[0];

  const streak = lastNonTieStreak(betState.history);

  let pick = best.side;
  let reason = `EVæœ€å¤§`;

  if (strategy === 'negok'){
    pick = best.side;
    reason = `å®¹å¿è² EVï¼ˆé–€æª» ${negTol}ï¼‰`;
  }

  if (strategy === 'follow'){
    if (streak.side && streak.len >= streakN){
      pick = streak.side;
      reason = `è¿½è·¯ï¼š${sideName(streak.side)}é€£ ${streak.len}ï¼ˆâ‰¥${streakN}ï¼‰`;
    } else {
      pick = best.side;
      reason = `è¿½è·¯æœªè§¸ç™¼ â†’ EVæœ€å¤§`;
    }
  }

  if (strategy === 'fade'){
    if (streak.side && streak.len >= streakN){
      pick = opposite(streak.side);
      reason = `åå‘ï¼š${sideName(streak.side)}é€£ ${streak.len}ï¼ˆâ‰¥${streakN}ï¼‰`;
    } else {
      pick = best.side;
      reason = `åå‘æœªè§¸ç™¼ â†’ EVæœ€å¤§`;
    }
  }

  if (strategy === 'martingale'){
    pick = best.side;
    reason = `é¦¬ä¸ï¼šæ–¹å‘=EVæœ€å¤§ï¼Œå–®ä½çœ‹è¼¸è´`;
  }

  setText('evLine', `EV(é–’)=${evP.toFixed(5)}ï½œEV(èŠ)=${evB.toFixed(5)}ï½œEV(å’Œ)=${evT.toFixed(5)}ï½œç­–ç•¥ï¼š${reason}`);
  return {pick, best, evP, evB, evT, negTol, strategy};
}

function updateBetUI(pP, pB, pT){
  const martCap = Math.max(2, parseInt(document.getElementById('martCap').value,10) || 8);

  const out = pickByStrategy(pP, pB, pT);
  let unit = betState.unit;

  if (out.strategy === 'negok'){
    if (out.best.ev < out.negTol){
      setText('betLine', `å»ºè­°ï¼š${sideName(out.pick)}ï½œå–®ä½ï¼š${unit}ï½œâš ï¸ EV=${out.best.ev.toFixed(5)} < ${out.negTol}ï¼ˆä»ç…§æŠ¼ï¼Œè¶…æ¿€é€²ï¼‰`);
    } else {
      setText('betLine', `å»ºè­°ï¼š${sideName(out.pick)}ï½œå–®ä½ï¼š${unit}ï½œEV=${out.best.ev.toFixed(5)} â‰¥ ${out.negTol}`);
    }
  } else if (out.strategy === 'martingale'){
    unit = Math.min(unit, martCap);
    setText('betLine', `å»ºè­°ï¼š${sideName(out.pick)}ï½œé¦¬ä¸å–®ä½ï¼š${unit}/${martCap}ï½œï¼ˆè¼¸â†’å€å£“ï¼›è´â†’å›åˆ° 1ï¼‰`);
  } else {
    setText('betLine', `å»ºè­°ï¼š${sideName(out.pick)}ï½œå–®ä½ï¼š${unit}ï½œï¼ˆæ¿€é€²ï¼šæ°¸é ä¸‹æ³¨ï¼‰`);
  }

  betState.lastPick = out.pick;
}

// è¨˜éŒ„çµæœæŒ‰éˆ•
function updateLastWinnerUI(){
  if (!betState.history.length){
    setText('lastWinner', 'â€”');
    setText('lastStreak', 'â€”');
    return;
  }
  const last = betState.history[betState.history.length - 1];
  setText('lastWinner', `ä¸Šå±€ï¼š${sideName(last)}`);

  const streak = lastNonTieStreak(betState.history);
  if (streak.side){
    setText('lastStreak', `ç›®å‰ï¼š${sideName(streak.side)} é€£ ${streak.len}`);
  } else {
    setText('lastStreak', `ç›®å‰ï¼šâ€”`);
  }
}

// ====== è¨˜éŒ„çµæœæŒ‰éˆ•ï¼ˆåŠ å…¥é¡¯ç¤º + åŠ å…¥è¨ˆç®—ï¼‰======
function calcBacktest(N){
  const logs = betState.logs || [];
  if (!logs.length){
    setText('backLine', 'â€”');
    return;
  }

  const n = Math.max(5, Math.min(500, parseInt(N,10) || 30));
  const last = logs.slice(-n);

  let win=0, loss=0, push=0, skip=0;
  let netUnits = 0;

  for (const x of last){
    // æ²’æœ‰å»ºè­°å°±ä¸ç®—
    if (!x.pick){ skip++; continue; }

    // åªå›æ¸¬ã€ŒèŠ/é–’ã€ï¼šå¦‚æœå»ºè­°æ˜¯å’Œï¼ˆTï¼‰å°±ç•¥éæˆ–ç•¶ skip
    if (x.pick === 'T'){ skip++; continue; }

    // çµæœæ˜¯å’Œï¼šPushï¼ˆä¸è¼¸ä¸è´ï¼‰
    if (x.result === 'T'){
      push++;
      continue;
    }

    // å‘½ä¸­åˆ¤å®š
    if (x.result === x.pick){
      win++;
      netUnits += (x.unit || 1);      // è´ï¼š+å–®ä½
    } else {
      loss++;
      netUnits -= (x.unit || 1);      // è¼¸ï¼š-å–®ä½
    }
  }

  const denom = win + loss;
  const hit = denom ? (win/denom) : 0;

  setText(
    'backLine',
    `å›æ¸¬è¿‘ ${last.length} æŠŠï¼šå‘½ä¸­ ${win}ï½œå¤±èª¤ ${loss}ï½œPush(å’Œ) ${push}ï½œç•¥é ${skip}ï½œå‘½ä¸­ç‡ ${(hit*100).toFixed(2)}%ï½œæ·¨å–®ä½ ${netUnits>0?'+':''}${netUnits}`
  );
}
function recordResult(r){
  // â‘  è¨˜éŒ„å¯¦éš›çµæœï¼ˆç‰Œè·¯ï¼‰
  betState.history.push(r);

  // â‘¡ é¡¯ç¤ºã€Œä¸Šå±€å‹å®¶ / ç›®å‰é€£ç·šã€
  updateLastWinnerUI();

  // â‘¢ é¦¬ä¸ï¼šä¾ä¸Šä¸€æŠŠå»ºè­°æ–¹å‘çš„è¼¸è´æ›´æ–°å–®ä½
  const martCap = Math.max(2, parseInt(document.getElementById('martCap')?.value,10) || 8);
  const strategy = document.getElementById('strategy')?.value;

  if (strategy === 'martingale' && betState.lastPick){
    if (r === 'T'){
      // å’Œï¼špushï¼Œä¸è®Š
    } else if (r === betState.lastPick){
      betState.unit = 1;
    } else {
      betState.unit = Math.min(betState.unit * 2, martCap);
    }
  }

  // â‘£ å›æ¸¬è¨˜éŒ„ï¼ˆâš ï¸ ä¸€å®šè¦åœ¨é€™è£¡ï¼Œå› ç‚º lastPick é‚„åœ¨ï¼‰
  betState.logs.push({
    pick: betState.lastPick,
    result: r,
    unit: betState.unit || 1
  });

  // â‘¤ è‹¥å·²æœ‰ç®—éæ©Ÿç‡ â†’ ç«‹å³ç”¨ã€Œä¿®æ­£å¾Œæ©Ÿç‡ã€æ›´æ–°ä¸‹æ³¨å»ºè­°
  if (lastCalc.has){
    updateBetUI(lastCalc.aP, lastCalc.aB, lastCalc.aT);
  }

  // âœ… â‘¥ã€å°±æ˜¯é€™è£¡ã€‘æ›´æ–°ã€Œè¿‘ N æŠŠå¯¦æˆ°å‘½ä¸­ç‡å›æ¸¬ã€
  const N = document.getElementById('backN')?.value || 30;
  calcBacktest(N);
}

lastCalc = {
  has: true,
  pP, pB, pT,        // åŸå§‹ MC
  aP: adj.aP,        // ä¿®æ­£å¾Œï¼ˆå¯¦æˆ°ç”¨ï¼‰
  aB: adj.aB,
  aT: adj.aT
};
// âœ… æ›´æ–°å›æ¸¬é¡¯ç¤º
const N = document.getElementById('backN')?.value || 30;
calcBacktest(N);
  }
}

//===========================
// ====== æ‰£ç‰Œ + MC ä¸»é«” ======
const DECKS = 8;
const counts0 = () => {
  const c = new Array(10).fill(0);
  c[0] = 16 * DECKS;
  for (let v=1; v<=9; v++) c[v] = 4 * DECKS;
  return c;
};

const state = {
  shoe: counts0(),
  seen: [],
  inited: false,
};

const rankToValue = (r) => {
  if (r === 'A') return 1;
  if (r === 'J' || r === 'Q' || r === 'K' || r === '10') return 0;
  const n = parseInt(r,10);
  if (!Number.isFinite(n) || n<2 || n>9) return null;
  return n;
};

function sumCounts(c){ return c.reduce((a,b)=>a+b,0); }

function shoeInfoText(){
  const left = sumCounts(state.shoe);
  const used = 416 - left;
  return `ç¸½å¼µæ•¸ 416ï½œå·²æ‰£ ${used}ï½œå‰©é¤˜ ${left}`;
}

function drawCard(counts){
  const total = sumCounts(counts);
  if (total <= 0) return null;
  let r = Math.floor(Math.random() * total);
  for (let v=0; v<=9; v++){
    const k = counts[v];
    if (r < k){
      counts[v]--;
      return v;
    }
    r -= k;
  }
  return null;
}

function mod10(x){ return ((x%10)+10)%10; }

function resolveHand(counts){
  const p1 = drawCard(counts), b1 = drawCard(counts);
  const p2 = drawCard(counts), b2 = drawCard(counts);
  if (p1===null||b1===null||p2===null||b2===null) return null;

  let pTotal = mod10(p1+p2);
  let bTotal = mod10(b1+b2);

  if (pTotal>=8 || bTotal>=8){
    if (pTotal>bTotal) return 'P';
    if (bTotal>pTotal) return 'B';
    return 'T';
  }

  let p3 = null;
  if (pTotal <= 5){
    p3 = drawCard(counts);
    if (p3===null) return null;
    pTotal = mod10(pTotal + p3);
  }

  let b3 = null;
  if (p3 === null){
    if (bTotal <= 5){
      b3 = drawCard(counts);
      if (b3===null) return null;
      bTotal = mod10(bTotal + b3);
    }
  } else {
    const pt = p3;
    if (bTotal <= 2){
      b3 = drawCard(counts);
    } else if (bTotal === 3){
      if (pt !== 8) b3 = drawCard(counts);
    } else if (bTotal === 4){
      if (pt >= 2 && pt <= 7) b3 = drawCard(counts);
    } else if (bTotal === 5){
      if (pt >= 4 && pt <= 7) b3 = drawCard(counts);
    } else if (bTotal === 6){
      if (pt === 6 || pt === 7) b3 = drawCard(counts);
    }
    if (b3 !== null){
      bTotal = mod10(bTotal + b3);
    }
  }

  if (pTotal>bTotal) return 'P';
  if (bTotal>pTotal) return 'B';
  return 'T';
}

function initNewShoe(){
  state.shoe = counts0();
  state.seen = [];
  state.inited = true;
  renderAll();
}

function canRemoveValue(v){
  return v!==null && v>=0 && v<=9 && state.shoe[v] > 0;
}

function addSeenRank(r){
  const v = rankToValue(r);
  if (v === null) return;
  if (!canRemoveValue(v)){
    alert('è©²é»æ•¸ç‰Œå·²è¢«æ‰£å…‰ï¼ˆæˆ–é‹å·²ç©ºï¼‰ï¼Œä¸èƒ½å†è¼¸å…¥ã€‚');
    return;
  }
  state.shoe[v]--;
  state.seen.push(v);
  renderAll();
}

function undo(){
  if (state.seen.length===0) return;
  const v = state.seen.pop();
  state.shoe[v]++;
  renderAll();
}

function clearSeen(){
  for (const v of state.seen) state.shoe[v]++;
  state.seen = [];
  renderAll();
}

function clearSeenUIOnly(){
  state.seen = [];
  renderAll();
}

function renderPills(){
  const el = document.getElementById('pills');
  if (!el) return;
  el.innerHTML = '';
  const toRank = (v) => v===0 ? '10/J/Q/K' : (v===1 ? 'A' : String(v));
  state.seen.forEach((v, idx) => {
    const pill = document.createElement('span');
    pill.className = 'pill';
    pill.innerHTML = `<span class="mono">#${idx+1}</span> <span>${toRank(v)}</span> <span class="x" title="ç§»é™¤">Ã—</span>`;
    pill.querySelector('.x').addEventListener('click', () => {
      state.shoe[v]++;
      state.seen.splice(idx,1);
      renderAll();
    });
    el.appendChild(pill);
  });
}

function renderAll(){
  setText('shoeInfo', shoeInfoText());
  renderPills();
}

async function runMC(){
  if (!state.inited) initNewShoe();

  updateRoadParamLabels();

  const trials = Math.max(5000, Math.min(500000, parseInt(document.getElementById('trials').value,10) || 50000));
  document.getElementById('trials').value = trials;

  if (sumCounts(state.shoe) < 60){
    alert('å‰©é¤˜ç‰Œå¤ªå°‘ï¼Œå»ºè­°é–‹æ–°é‹ã€‚');
    return;
  }

  const t0 = performance.now();
  let wP=0, wB=0, wT=0, bad=0;

  for (let i=0;i<trials;i++){
    const c = state.shoe.slice();
    const r = resolveHand(c);
    if (!r){ bad++; continue; }
    if (r==='P') wP++;
    else if (r==='B') wB++;
    else wT++;
  }

  const n = wP+wB+wT;
  const pP = n ? (wP/n) : 0;
  const pB = n ? (wB/n) : 0;
  const pT = n ? (wT/n) : 0;
  const t1 = performance.now();

  // åŸå§‹é¡¯ç¤º
  setText('pP', fmtPct(pP)); setText('pB', fmtPct(pB)); setText('pT', fmtPct(pT));
  setText('pP2', `æ¨£æœ¬ ${wP}/${n}`); setText('pB2', `æ¨£æœ¬ ${wB}/${n}`); setText('pT2', `æ¨£æœ¬ ${wT}/${n}`);
  setText('ms', (t1-t0).toFixed(0) + ' ms');

  // âœ… å¯¦æˆ°æ´¾ï¼šç‰Œè·¯ä¿®æ­£ï¼ˆç”¨ betState.historyï¼‰
  const adj = applyRoadAdjust(pP, pB, pT, betState.history);

  setText('pP_adj', `ä¿®æ­£å¾Œï¼š${fmtPct(adj.pP)}`);
  setText('pB_adj', `ä¿®æ­£å¾Œï¼š${fmtPct(adj.pB)}`);
  setText('pT_adj', `ä¿®æ­£å¾Œï¼š${fmtPct(adj.pT)}`);

  // é¡¯ç¤º topbarï¼šä¸è¦åªé¡¯ç¤ºã€Œä¸‹èŠã€ï¼Œæ”¹æˆé¡¯ç¤ºã€Œå»ºè­°ä¸‹ï¼šXã€
  const maxSide = (adj.pB>=adj.pP && adj.pB>=adj.pT) ? 'B' : (adj.pP>=adj.pB && adj.pP>=adj.pT) ? 'P' : 'T';
  if (maxSide==='B'){ setText('scoreP',''); setText('scoreB','èŠ'); }
  else if (maxSide==='P'){ setText('scoreP','é–’'); setText('scoreB',''); }
  else { setText('scoreP','å’Œ'); setText('scoreB',''); }

  // âœ… EV/ä¸‹æ³¨ï¼šä»¥ã€Œä¿®æ­£å¾Œã€ç‚ºä¸»ï¼Œä½†ä¹ŸæŠŠä¿®æ­£åŸå› å¸¶ä¸Š
  const commission = parseFloat(document.getElementById('commission').value || '0.05');
  const rawEV = calcEV(pP, pB, pT, commission);
  const adjEV = calcEV(adj.pP, adj.pB, adj.pT, commission);

  setText(
    'evLine',
    `åŸå§‹EVï¼šé–’=${rawEV.evP.toFixed(5)}ï½œèŠ=${rawEV.evB.toFixed(5)}ï½œå’Œ=${rawEV.evT.toFixed(5)}  ` +
    `ï½œä¿®æ­£EVï¼šé–’=${adjEV.evP.toFixed(5)}ï½œèŠ=${adjEV.evB.toFixed(5)}ï½œå’Œ=${adjEV.evT.toFixed(5)}  ` +
    `ï½œç‰Œè·¯ï¼š${adj.note}`
  );

  // ä¸‹æ³¨å»ºè­°/ç­–ç•¥ç”¨ä¿®æ­£å¾Œå‹ç‡ï¼ˆå¯¦æˆ°æ´¾ï¼‰
  if (typeof updateBetUI === 'function') updateBetUI(adj.pP, adj.pB, adj.pT);

  // ä½ åŸæœ¬è¨­è¨ˆï¼šç®—å®Œå°±æŠŠã€Œé€™æ¬¡è¼¸å…¥ç‰Œã€æ¸…æ‰ï¼Œä½†æ‰£ç‰Œä¿ç•™
  clearSeenUIOnly();

  if (bad>0) console.log('bad trials:', bad);
}

function on(id, ev, fn){
  const el = document.getElementById(id);
  if (el) el.addEventListener(ev, fn);
}

window.addEventListener('DOMContentLoaded', () => {
  updateRoadParamLabels();

  // âœ… ç‰ŒæŒ‰éˆ•ï¼šäº‹ä»¶å§”æ´¾ï¼ˆæœ€ç©©ï¼‰
  const pad = document.querySelector('.pad');
  if (pad){
    pad.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-r]');
      if (!btn) return;
      addSeenRank(btn.getAttribute('data-r'));
    });
  }

  on('btnUndo', 'click', undo);
  on('btnClear', 'click', clearSeen);
  on('btnNewShoe', 'click', initNewShoe);
  on('btnCalc', 'click', runMC);

  // ç‰Œè·¯/ç­–ç•¥ç´€éŒ„
  on('recB', 'click', ()=> recordResult('B'));
  on('recP', 'click', ()=> recordResult('P'));
  on('recT', 'click', ()=> recordResult('T'));
  on('recClear','click', ()=>{
    betState.history = [];
    betState.unit = 1;
    betState.lastPick = null;
    setText('betLine', 'â€”');
    // åŒæ­¥æŠŠä¿®æ­£å¾Œé¡¯ç¤ºæ¸…ä¸€ä¸‹
    setText('pP_adj', 'ä¿®æ­£å¾Œï¼šâ€”');
    setText('pB_adj', 'ä¿®æ­£å¾Œï¼šâ€”');
    setText('pT_adj', 'ä¿®æ­£å¾Œï¼šâ€”');
  });

  // åƒæ•¸æ”¹å‹• â†’ åªæ›´æ–°æ•¸å­—é¡¯ç¤ºï¼Œä¸è‡ªå‹•è·‘ MCï¼ˆé¿å…æ‰‹æ©Ÿå¡ï¼‰
  ['roadOn','roadWin','wTrend','wChop','wTie'].forEach(id=>{
    on(id, 'input', updateRoadParamLabels);
    on(id, 'change', updateRoadParamLabels);
  });

  initNewShoe();
});
</script>
</body>
</html>