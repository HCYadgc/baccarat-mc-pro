<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>百家樂｜純核心＋Seed/Crypto RNG 切換版</title>
  <style>
    body{
      margin:0;padding:16px;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC",Arial,sans-serif;
      background:#0b1020;color:#eaf0ff;
    }
    .wrap{max-width:980px;margin:0 auto;}
    h1{margin:0 0 12px;font-size:20px;}
    .box{
      background:#ffffff10;border:1px solid #ffffff22;border-radius:14px;
      padding:12px;margin-bottom:12px;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    label{display:flex;gap:6px;align-items:center;}
    input,select{
      background:#0000002a;border:1px solid #ffffff20;color:#eaf0ff;
      border-radius:10px;padding:6px 10px;font-weight:800;
    }
    button{
      appearance:none;border:none;
      background:#ffffff14;border:1px solid #ffffff20;color:#eaf0ff;
      padding:8px 14px;border-radius:12px;
      font-weight:900;cursor:pointer;
    }
    button:hover{background:#ffffff1a;}
    pre{
      margin:0;white-space:pre-wrap;word-break:break-word;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      color:#d8e3ff;
    }
    .muted{color:#b7c3e6;font-size:13px;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>百家樂｜純核心（補牌正確）＋ Seed / Crypto RNG</h1>

  <div class="box">
    <div class="row">
      <label>RNG
        <select id="rngMode">
          <option value="seed" selected>Seed（可重現）</option>
          <option value="crypto">Crypto（真實亂數）</option>
        </select>
      </label>
      <label>Seed <input id="seed" value="123456789"></label>
      <label>Decks <input id="decks" type="number" value="8" min="1"></label>
      <label>Trials <input id="trials" type="number" value="100000" step="10000"></label>
      <label>Runs <input id="runs" type="number" value="10" min="3"></label>
      <button id="btnRun">跑驗證</button>
    </div>
    <div class="muted">
      預設使用 Seed RNG（工程驗證）；切到 Crypto 可模擬真實牌局亂數。
    </div>
  </div>

  <div class="box">
    <pre id="out">—</pre>
  </div>
</div>

<script>
/* ======================================================
   RNG 核心（預設 Seed，可切 Crypto）
====================================================== */
const RNG = {
  mode: 'seed',
  seed: '123456789',
  _rng: null,
  _u32: new Uint32Array(1)
};

function xorshift32(seed){
  let x = seed >>> 0;
  if (x === 0) x = 0x9e3779b9;
  return () => {
    x ^= (x << 13) >>> 0;
    x ^= (x >>> 17) >>> 0;
    x ^= (x << 5) >>> 0;
    return x >>> 0;
  };
}

function initSeedRNG(){
  let h = 2166136261 >>> 0;
  for (let i=0;i<RNG.seed.length;i++){
    h ^= RNG.seed.charCodeAt(i);
    h = Math.imul(h,16777619)>>>0;
  }
  RNG._rng = xorshift32(h);
}

function randInt(n){
  if (n<=0) return 0;
  const limit = Math.floor(0x100000000/n)*n;
  while(true){
    let x;
    if (RNG.mode==='crypto'){
      crypto.getRandomValues(RNG._u32);
      x = RNG._u32[0];
    }else{
      x = RNG._rng();
    }
    if (x<limit) return x % n;
  }
}

/* ======================================================
   牌鞋（點數 0~9）
====================================================== */
function counts0(decks){
  const c=new Array(10).fill(0);
  c[0]=16*decks;
  for(let i=1;i<=9;i++) c[i]=4*decks;
  return c;
}
function sum(c){return c.reduce((a,b)=>a+b,0);}
function mod10(x){return ((x%10)+10)%10;}

function drawCard(c){
  let r=randInt(sum(c));
  for(let i=0;i<=9;i++){
    if(r<c[i]){c[i]--;return i;}
    r-=c[i];
  }
  return null;
}

/* ======================================================
   百家樂補牌（完全依你給的規則）
====================================================== */
function resolveHand(shoe){
  const c=shoe.slice();
  const p1=drawCard(c),b1=drawCard(c);
  const p2=drawCard(c),b2=drawCard(c);
  if(p1==null||b1==null||p2==null||b2==null) return null;

  let pT=mod10(p1+p2), bT=mod10(b1+b2);

  if(pT>=8||bT>=8){
    if(pT>bT) return 'P';
    if(bT>pT) return 'B';
    return 'T';
  }

  let p3=null;
  if(pT<=5){
    p3=drawCard(c);
    pT=mod10(pT+p3);
  }

  if(p3===null){
    if(bT<=5){
      bT=mod10(bT+drawCard(c));
    }
  }else{
    if(bT<=2) bT=mod10(bT+drawCard(c));
    else if(bT===3 && p3!==8) bT=mod10(bT+drawCard(c));
    else if(bT===4 && p3>=2&&p3<=7) bT=mod10(bT+drawCard(c));
    else if(bT===5 && p3>=4&&p3<=7) bT=mod10(bT+drawCard(c));
    else if(bT===6 && (p3===6||p3===7)) bT=mod10(bT+drawCard(c));
  }

  if(pT>bT) return 'P';
  if(bT>pT) return 'B';
  return 'T';
}

/* ======================================================
   驗證
====================================================== */
function runVerify(){
  const decks=+decksInput.value;
  const trials=+trialsInput.value;
  const runs=+runsInput.value;

  const results=[];
  for(let r=0;r<runs;r++){
    const shoe=counts0(decks);
    let p=0,b=0,t=0;
    for(let i=0;i<trials;i++){
      const res=resolveHand(shoe);
      if(res==='P')p++;
      else if(res==='B')b++;
      else t++;
    }
    const n=p+b+t;
    results.push({
      p:p/n,b:b/n,t:t/n
    });
  }

  let out=`RNG=${RNG.mode}  Seed=${RNG.seed}\n\n`;
  results.forEach((r,i)=>{
    out+=`Run#${i} P=${(r.p*100).toFixed(4)}% B=${(r.b*100).toFixed(4)}% T=${(r.t*100).toFixed(4)}%\n`;
  });
  write(out);
}

function write(s){out.textContent=s;}

/* ======================================================
   UI 綁定
====================================================== */
const out=document.getElementById('out');
const seedInput=document.getElementById('seed');
const decksInput=document.getElementById('decks');
const trialsInput=document.getElementById('trials');
const runsInput=document.getElementById('runs');

document.getElementById('rngMode').onchange=e=>{
  RNG.mode=e.target.value;
  if(RNG.mode==='seed') initSeedRNG();
};

document.getElementById('btnRun').onclick=()=>{
  RNG.seed=seedInput.value;
  if(RNG.mode==='seed') initSeedRNG();
  runVerify();
};

initSeedRNG();
runVerify();
</script>
</body>
</html>